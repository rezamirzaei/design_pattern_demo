<div class="pattern-card" id="pattern-composite" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">ğŸ¢</div>
        <div class="pattern-info">
            <h3>Unified Control Hierarchy</h3>
            <span class="pattern-badge badge-structural">Composite Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Treat individual devices (Leaves) and groups of devices (Composites) uniformly.
        Whether you target a single bulb, a room, a floor, or the entire house, the <strong>Composite Pattern</strong> ensures the command propagates correctly.
    </p>

    <div class="pattern-demo">
        <h4>ğŸ® House Hierarchy</h4>

        <div class="hierarchy-tree" style="padding: 30px; background: var(--darker); border-radius: 16px; margin-bottom: 25px; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <!-- Root: Whole House -->
            <div class="tree-node house" onclick="Composite.control('house','toggle')" style="display: flex; align-items: center; gap: 20px; padding: 18px 25px; background: rgba(255, 193, 7, 0.15); border: 1px solid var(--warning); border-radius: 12px; margin-bottom: 20px; cursor: pointer; transition: all 0.3s; position: relative;">
                <div class="node-icon" style="font-size: 2.2em; background: rgba(0,0,0,0.2); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">ğŸ </div>
                <div class="node-name" style="font-weight: 700; flex: 1; font-size: 1.1em; color: var(--warning);">Whole House</div>
                <div class="node-count" style="font-size: 0.85em; color: var(--text-muted); background: rgba(0,0,0,0.3); padding: 5px 12px; border-radius: 20px; border: 1px solid var(--glass-border);">12 Devices</div>
            </div>

            <div class="tree-level" style="margin-left: 35px; padding-left: 25px; border-left: 2px dashed var(--glass-border);">
                <!-- Node: First Floor -->
                <div class="tree-node floor" onclick="Composite.control('floor-1','toggle')" style="display: flex; align-items: center; gap: 15px; padding: 15px 20px; background: rgba(40, 167, 69, 0.15); border: 1px solid #28a745; border-radius: 12px; margin-bottom: 20px; cursor: pointer; transition: all 0.3s;">
                    <div class="node-icon" style="font-size: 1.8em;">ğŸ¢</div>
                    <div class="node-name" style="font-weight: 600; flex: 1; color: #28a745;">First Floor</div>
                    <div class="node-count" style="font-size: 0.8em; color: var(--text-muted); background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 10px;">7 Devices</div>
                </div>

                <div class="tree-sublevel" style="margin-left: 35px; padding-left: 25px; border-left: 2px dashed var(--glass-border);">
                    <!-- Leaf Composite: Living Room -->
                    <div class="tree-node room" onclick="Composite.control('living-room','toggle')" style="display: flex; flex-direction: column; gap: 12px; padding: 18px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 12px; margin-bottom: 15px; cursor: pointer; transition: all 0.2s;">
                        <div style="display: flex; align-items: center; width: 100%; gap: 15px;">
                            <div class="node-icon" style="font-size: 1.5em;">ğŸ›‹ï¸</div>
                            <div class="node-name" style="font-weight: 600; flex: 1;">Living Room</div>
                            <div class="node-count" style="font-size: 0.8em; color: var(--text-muted);">3 Devices</div>
                        </div>
                        <div class="room-devices" style="display: flex; gap: 10px; width: 100%;">
                            <span class="device-chip" onclick="event.stopPropagation();Composite.control('living-light','toggle')" style="padding: 6px 14px; background: rgba(0, 210, 255, 0.1); border: 1px solid rgba(0, 210, 255, 0.3); border-radius: 20px; font-size: 0.8em; color: var(--primary); font-weight: 500;">ğŸ’¡ Light</span>
                            <span class="device-chip" onclick="event.stopPropagation();Composite.control('living-tv','toggle')" style="padding: 6px 14px; background: rgba(0, 210, 255, 0.1); border: 1px solid rgba(0, 210, 255, 0.3); border-radius: 20px; font-size: 0.8em; color: var(--primary); font-weight: 500;">ğŸ“º TV</span>
                            <span class="device-chip" onclick="event.stopPropagation();Composite.control('living-speaker','toggle')" style="padding: 6px 14px; background: rgba(0, 210, 255, 0.1); border: 1px solid rgba(0, 210, 255, 0.3); border-radius: 20px; font-size: 0.8em; color: var(--primary); font-weight: 500;">ğŸ”Š Speaker</span>
                        </div>
                    </div>

                    <!-- Leaf Composite: Kitchen -->
                    <div class="tree-node room" onclick="Composite.control('kitchen','toggle')" style="display: flex; flex-direction: column; gap: 12px; padding: 18px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 12px; margin-bottom: 15px; cursor: pointer; transition: all 0.2s;">
                        <div style="display: flex; align-items: center; width: 100%; gap: 15px;">
                            <div class="node-icon" style="font-size: 1.5em;">ğŸ³</div>
                            <div class="node-name" style="font-weight: 600; flex: 1;">Kitchen</div>
                            <div class="node-count" style="font-size: 0.8em; color: var(--text-muted);">2 Devices</div>
                        </div>
                        <div class="room-devices" style="display: flex; gap: 10px; width: 100%;">
                            <span class="device-chip" onclick="event.stopPropagation();Composite.control('kitchen-light','toggle')" style="padding: 6px 14px; background: rgba(0, 210, 255, 0.1); border: 1px solid rgba(0, 210, 255, 0.3); border-radius: 20px; font-size: 0.8em; color: var(--primary); font-weight: 500;">ğŸ’¡ Light</span>
                            <span class="device-chip" onclick="event.stopPropagation();Composite.control('kitchen-sensor','toggle')" style="padding: 6px 14px; background: rgba(0, 210, 255, 0.1); border: 1px solid rgba(0, 210, 255, 0.3); border-radius: 20px; font-size: 0.8em; color: var(--primary); font-weight: 500;">ğŸ“¡ Sensor</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="composite-actions" style="padding: 25px; background: rgba(0, 210, 255, 0.05); border-radius: 16px; border: 1px solid var(--glass-border);">
            <h5 style="color: var(--primary); margin-bottom: 20px; font-size: 0.9em; text-transform: uppercase;">ğŸ¯ Quick Group Actions</h5>
            <div class="group-btns" style="display: flex; flex-wrap: wrap; gap: 15px;">
                <button class="action-btn" onclick="Composite.control('house','on')" style="padding: 12px 24px; background: rgba(255, 193, 7, 0.15); border: 1px solid var(--warning); border-radius: 8px; color: var(--warning); cursor: pointer; flex: 1; font-weight: 600;">
                    ğŸ  ALL ON
                </button>
                <button class="action-btn" onclick="Composite.control('house','off')" style="padding: 12px 24px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-muted); cursor: pointer; flex: 1; font-weight: 600;">
                    ğŸ  ALL OFF
                </button>
                <button class="action-btn" onclick="Composite.control('living-room','on')" style="padding: 12px 24px; background: rgba(0, 210, 255, 0.15); border: 1px solid var(--primary); border-radius: 8px; color: var(--primary); cursor: pointer; flex: 1; font-weight: 600;">
                    ğŸ›‹ï¸ Living ON
                </button>
            </div>
        </div>

        <div class="pattern-explanation" style="margin-top: 25px;">
            <h5>ğŸ’¡ Pattern Logic</h5>
            <ul>
                <li><strong>Component Interface:</strong> Defines `execute(command)` for everything.</li>
                <li><strong>Composite:</strong> Holds a list of children (`List&lt;SmartHomeComponent&gt;`) and delegates commands recursively.</li>
                <li><strong>Leaf:</strong> The actual device that executes the command.</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="composite-result"></div>
<script>
var Composite = {
    control: function(target, action) {
        var names = {
            'house':'Whole House','floor-1':'First Floor','living-room':'Living Room',
            'kitchen':'Kitchen','bedroom':'Bedroom','living-light':'Living Light',
            'living-tv':'TV','living-speaker':'Speaker','kitchen-light':'Kitchen Light',
            'kitchen-sensor':'Sensor','bed-light':'Bed Light','bed-thermo':'Thermostat'
        };
        var counts = {
            'house':12,'floor-1':7,'living-room':3,'kitchen':2,'bedroom':2
        };
        var isGroup = counts[target] !== undefined;
        var affected = isGroup ? counts[target] : 1;

        // Visual feedback on the node
        var selector = target === 'house' ? '.tree-node.house' :
                       target === 'floor-1' ? '.tree-node.floor' :
                       '.tree-node.room[onclick*="' + target + '"]';

        var node = document.querySelector(selector);
        if(node && action === 'toggle') {
            // Simple animation effect
            node.style.transform = 'scale(0.98)';
            setTimeout(() => node.style.transform = 'scale(1)', 150);
        }

        fetch('/api/patterns/composite/control?target=' + target + '&action=' + action, {method:'POST'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var msg = 'ğŸŒ³ Command Propagated\n' +
                          '---------------------\n' +
                          'Target: ' + (isGroup ? 'NODE (Group)' : 'LEAF (Device)') + '\n' +
                          'Name: ' + names[target] + '\n' +
                          'Command: ' + action.toUpperCase() + '\n' +
                          'Scope: ' + affected + ' device(s) affected\n\n' +
                          (isGroup ? 'The Composite pattern automatically distributed the command down the tree structure.' : 'Direct control of leaf node.');

                PatternDemo.showResult('composite-result', msg);
                PatternDemo.toast(names[target] + (action === 'toggle' ? ' Toggled' : ' ' + action.toUpperCase()), 'success');
            });
    }
};
</script>
</div>
