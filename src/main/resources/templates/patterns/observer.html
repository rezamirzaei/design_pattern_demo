<div class="pattern-card" id="pattern-observer" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">üëÄ</div>
        <div class="pattern-info">
            <h3>Device Event Notifications</h3>
            <span class="pattern-badge badge-behavioral">Observer Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Subscribe to device events and get <strong>notified automatically</strong> when something changes.
        Multiple observers can watch the same device - phone, email, dashboard all get updates!
    </p>
    <div class="pattern-demo">
        <h4>üéÆ Setup Event Subscriptions</h4>
        <div class="observer-workspace">
            <!-- Subscription Setup -->
            <div class="subscription-panel">
                <div class="devices-column">
                    <h5>üì± Select Device to Watch</h5>
                    <div class="watch-device-list">
                        <button class="watch-device active" data-device="motion-sensor" onclick="Observer.selectDevice(this, 'motion-sensor')">
                            <span class="wd-icon">üö∂</span>
                            <span class="wd-name">Motion Sensor</span>
                        </button>
                        <button class="watch-device" data-device="door-sensor" onclick="Observer.selectDevice(this, 'door-sensor')">
                            <span class="wd-icon">üö™</span>
                            <span class="wd-name">Door Sensor</span>
                        </button>
                        <button class="watch-device" data-device="front-camera" onclick="Observer.selectDevice(this, 'front-camera')">
                            <span class="wd-icon">üì∑</span>
                            <span class="wd-name">Front Camera</span>
                        </button>
                        <button class="watch-device" data-device="thermostat" onclick="Observer.selectDevice(this, 'thermostat')">
                            <span class="wd-icon">üå°Ô∏è</span>
                            <span class="wd-name">Thermostat</span>
                        </button>
                        <button class="watch-device" data-device="smoke-detector" onclick="Observer.selectDevice(this, 'smoke-detector')">
                            <span class="wd-icon">üî•</span>
                            <span class="wd-name">Smoke Detector</span>
                        </button>
                    </div>
                </div>
                <div class="observers-column">
                    <h5>üîî Choose Notification Methods</h5>
                    <div class="observer-list">
                        <label class="observer-checkbox">
                            <input type="checkbox" value="MOBILE" checked>
                            <span class="obs-box">
                                <span class="obs-icon">üì±</span>
                                <span class="obs-info">
                                    <span class="obs-name">Mobile Push</span>
                                    <span class="obs-desc">Instant push notifications</span>
                                </span>
                            </span>
                        </label>
                        <label class="observer-checkbox">
                            <input type="checkbox" value="EMAIL">
                            <span class="obs-box">
                                <span class="obs-icon">üìß</span>
                                <span class="obs-info">
                                    <span class="obs-name">Email Alert</span>
                                    <span class="obs-desc">Detailed email notification</span>
                                </span>
                            </span>
                        </label>
                        <label class="observer-checkbox">
                            <input type="checkbox" value="DASHBOARD">
                            <span class="obs-box">
                                <span class="obs-icon">üìä</span>
                                <span class="obs-info">
                                    <span class="obs-name">Dashboard</span>
                                    <span class="obs-desc">Update home dashboard</span>
                                </span>
                            </span>
                        </label>
                        <label class="observer-checkbox">
                            <input type="checkbox" value="LOG">
                            <span class="obs-box">
                                <span class="obs-icon">üìù</span>
                                <span class="obs-info">
                                    <span class="obs-name">Event Log</span>
                                    <span class="obs-desc">Record to history</span>
                                </span>
                            </span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn-subscribe" onclick="Observer.subscribe()">
                    <span>üîî</span> Subscribe Selected
                </button>
                <button class="btn-trigger" onclick="Observer.triggerEvent()">
                    <span>‚ö°</span> Simulate Device Event
                </button>
            </div>
            <!-- Active Subscriptions -->
            <div class="active-subscriptions">
                <h5>üìã Active Subscriptions</h5>
                <div class="subscriptions-list" id="subscriptions-list">
                    <div class="no-subs">No subscriptions yet. Subscribe observers to devices above!</div>
                </div>
            </div>
            <!-- Event Log -->
            <div class="event-log">
                <h5>üì® Event Notifications</h5>
                <div class="event-list" id="event-list">
                    <div class="no-events">Trigger a device event to see notifications...</div>
                </div>
            </div>
        </div>
        <div class="pattern-explanation">
            <h5>üí° How Observer Works Here:</h5>
            <ul>
                <li>Devices are <strong>Subjects</strong> - they maintain a list of observers</li>
                <li>Notification services (Mobile, Email, etc.) are <strong>Observers</strong></li>
                <li>When device state changes, it calls <code>notifyAll()</code></li>
                <li>Each observer's <code>update()</code> method is called automatically</li>
                <li>Observers can be added/removed at runtime without changing device code</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="observer-result"></div>
</div>
<script>
var Observer = {
    selectedDevice: 'motion-sensor',
    subscriptions: [],
    eventCount: 0,
    selectDevice: function(btn, device) {
        document.querySelectorAll('.watch-device').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        this.selectedDevice = device;
    },
    getSelectedObservers: function() {
        var observers = [];
        document.querySelectorAll('.observer-checkbox input:checked').forEach(function(cb) {
            observers.push(cb.value);
        });
        return observers;
    },
    subscribe: function() {
        var observers = this.getSelectedObservers();
        if (observers.length === 0) {
            PatternDemo.toast('Select at least one notification method!', 'error');
            return;
        }
        var device = this.selectedDevice;
        var self = this;
        var promises = observers.map(function(obs) {
            return fetch('/api/patterns/observer/subscribe?deviceId=' + device + '&observerType=' + obs, { method: 'POST' })
                .then(function(r) { return r.json(); });
        });
        Promise.all(promises).then(function() {
            observers.forEach(function(obs) {
                self.subscriptions.push({ device: device, observer: obs });
            });
            self.updateSubscriptionsList();
            PatternDemo.toast('Subscribed ' + observers.length + ' observer(s) to ' + device, 'success');
        });
    },
    updateSubscriptionsList: function() {
        var list = document.getElementById('subscriptions-list');
        if (this.subscriptions.length === 0) {
            list.innerHTML = '<div class="no-subs">No subscriptions yet.</div>';
            return;
        }
        var icons = { MOBILE: 'üì±', EMAIL: 'üìß', DASHBOARD: 'üìä', LOG: 'üìù' };
        var html = '';
        this.subscriptions.forEach(function(sub) {
            html += '<div class="sub-item">';
            html += '<span class="sub-device">' + sub.device + '</span>';
            html += '<span class="sub-arrow">‚Üí</span>';
            html += '<span class="sub-observer">' + icons[sub.observer] + ' ' + sub.observer + '</span>';
            html += '</div>';
        });
        list.innerHTML = html;
    },
    triggerEvent: function() {
        var device = this.selectedDevice;
        var self = this;
        fetch('/api/patterns/observer/trigger?deviceId=' + device, { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                self.eventCount++;
                var eventList = document.getElementById('event-list');
                // Find subscriptions for this device
                var deviceSubs = self.subscriptions.filter(function(s) { return s.device === device; });
                var icons = { MOBILE: 'üì±', EMAIL: 'üìß', DASHBOARD: 'üìä', LOG: 'üìù' };
                var html = eventList.innerHTML;
                if (html.indexOf('no-events') >= 0) html = '';
                html = '<div class="event-item new">' +
                    '<div class="event-header">' +
                    '<span class="event-time">' + new Date().toLocaleTimeString() + '</span>' +
                    '<span class="event-device">‚ö° ' + device + ' triggered</span>' +
                    '</div>' +
                    '<div class="event-notifications">' +
                    deviceSubs.map(function(s) {
                        return '<span class="notif-sent">' + icons[s.observer] + ' ' + s.observer + ' notified</span>';
                    }).join('') +
                    (deviceSubs.length === 0 ? '<span class="no-notif">No observers subscribed</span>' : '') +
                    '</div>' +
                    '</div>' + html;
                eventList.innerHTML = html;
                PatternDemo.showResult('observer-result',
                    'Event triggered on "' + device + '"!\n\n' +
                    'Observers notified: ' + deviceSubs.length + '\n' +
                    deviceSubs.map(function(s) { return '  ‚Ä¢ ' + s.observer; }).join('\n') +
                    '\n\nEach observer received the update through their update() method.'
                );
                PatternDemo.toast('Event: ' + device, 'info');
            });
    }
};
</script>
<style>
.observer-workspace { display: flex; flex-direction: column; gap: 20px; }
.subscription-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.devices-column h5, .observers-column h5 { color: #00d2ff; margin-bottom: 12px; font-size: 0.95em; }
.watch-device-list { display: flex; flex-direction: column; gap: 8px; }
.watch-device { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; color: white; cursor: pointer; transition: all 0.3s; }
.watch-device:hover { background: rgba(0,210,255,0.1); border-color: rgba(0,210,255,0.3); }
.watch-device.active { background: rgba(0,210,255,0.2); border-color: #00d2ff; }
.wd-icon { font-size: 1.3em; }
.observer-list { display: flex; flex-direction: column; gap: 8px; }
.observer-checkbox { cursor: pointer; }
.observer-checkbox input { display: none; }
.obs-box { display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; transition: all 0.3s; }
.observer-checkbox input:checked + .obs-box { background: rgba(0,210,255,0.15); border-color: #00d2ff; }
.obs-icon { font-size: 1.3em; }
.obs-info { display: flex; flex-direction: column; }
.obs-name { font-weight: 500; color: #fff; }
.obs-desc { font-size: 0.75em; color: #888; }
.action-buttons { display: flex; gap: 15px; }
.btn-subscribe, .btn-trigger { flex: 1; padding: 12px; border: none; border-radius: 10px; color: white; font-size: 1em; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
.btn-subscribe { background: linear-gradient(90deg, #00d2ff, #3a7bd5); }
.btn-trigger { background: linear-gradient(90deg, #f093fb, #f5576c); }
.btn-subscribe:hover, .btn-trigger:hover { transform: scale(1.02); }
.active-subscriptions, .event-log { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 15px; }
.active-subscriptions h5, .event-log h5 { color: #00d2ff; margin-bottom: 12px; font-size: 0.9em; }
.no-subs, .no-events { color: #666; font-style: italic; font-size: 0.9em; }
.sub-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 5px; }
.sub-device { color: #fff; }
.sub-arrow { color: #666; }
.sub-observer { color: #00d2ff; }
.event-item { padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #00d2ff; }
.event-item.new { animation: fadeIn 0.5s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
.event-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
.event-time { color: #888; font-size: 0.8em; }
.event-device { color: #fff; font-weight: 500; }
.event-notifications { display: flex; flex-wrap: wrap; gap: 8px; }
.notif-sent { padding: 4px 10px; background: rgba(0,210,255,0.2); border-radius: 15px; font-size: 0.8em; color: #00d2ff; }
.no-notif { color: #888; font-size: 0.8em; font-style: italic; }
@media (max-width: 768px) { .subscription-panel { grid-template-columns: 1fr; } .action-buttons { flex-direction: column; } }
</style>
