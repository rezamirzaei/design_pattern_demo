<div class="pattern-card" id="pattern-observer" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">üëÄ</div>
        <div class="pattern-info">
            <h3>Event Broadcaster</h3>
            <span class="pattern-badge badge-behavioral">Observer Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Define a one-to-many dependency between objects so that when one object changes state, all its dependents are <strong>notified and updated automatically</strong>.
    </p>

    <div class="pattern-demo">
        <h4>üéÆ Subscription Manager</h4>

        <div class="observer-workspace" style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 25px;">
            <!-- Setup Panel -->
            <div class="setup-panel" style="flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 20px;">
                <div class="subject-selection" style="background: var(--glass-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                    <h5 style="color: var(--primary); margin-bottom: 15px; font-size: 0.9em; text-transform: uppercase;">1. Select Subject (Publisher)</h5>
                    <div class="watch-device-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                        <button class="watch-device active" data-device="motion-sensor" onclick="Observer.selectDevice(this, 'motion-sensor')" style="padding: 15px; background: rgba(0, 210, 255, 0.15); border: 1px solid var(--primary); border-radius: 10px; cursor: pointer; text-align: center; color: var(--text); transition: all 0.3s;">
                            <span style="font-size: 2em; display: block; margin-bottom: 5px;">üö∂</span>
                            <span>Motion Sensor</span>
                        </button>
                        <button class="watch-device" data-device="door-bell" onclick="Observer.selectDevice(this, 'door-bell')" style="padding: 15px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; cursor: pointer; text-align: center; color: var(--text); transition: all 0.3s;">
                            <span style="font-size: 2em; display: block; margin-bottom: 5px;">üîî</span>
                            <span>Door Bell</span>
                        </button>
                        <button class="watch-device" data-device="smoke-alarm" onclick="Observer.selectDevice(this, 'smoke-alarm')" style="padding: 15px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; cursor: pointer; text-align: center; color: var(--text); transition: all 0.3s;">
                            <span style="font-size: 2em; display: block; margin-bottom: 5px;">üî•</span>
                            <span>Smoke Alarm</span>
                        </button>
                    </div>
                </div>

                <div class="observer-selection" style="background: var(--glass-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border);">
                    <h5 style="color: var(--warning); margin-bottom: 15px; font-size: 0.9em; text-transform: uppercase;">2. Attach Observers (Subscribers)</h5>
                    <div class="observer-list" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <label class="feature-box" style="padding: 12px; background: var(--glass-bg); border-radius: 8px; border: 1px solid var(--glass-border); cursor: pointer; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" value="MOBILE" checked style="accent-color: var(--warning);">
                            <span>üì± Mobile App</span>
                        </label>
                        <label class="feature-box" style="padding: 12px; background: var(--glass-bg); border-radius: 8px; border: 1px solid var(--glass-border); cursor: pointer; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" value="EMAIL">
                            <span>üìß Email Service</span>
                        </label>
                        <label class="feature-box" style="padding: 12px; background: var(--glass-bg); border-radius: 8px; border: 1px solid var(--glass-border); cursor: pointer; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" value="LOG">
                            <span>üìù Logger</span>
                        </label>
                        <label class="feature-box" style="padding: 12px; background: var(--glass-bg); border-radius: 8px; border: 1px solid var(--glass-border); cursor: pointer; display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" value="SIREN">
                            <span>üö® Siren API</span>
                        </label>
                    </div>
                    <button class="btn-primary" onclick="Observer.subscribe()" style="width: 100%; margin-top: 15px; background: linear-gradient(90deg, var(--warning), #ff9800);">
                        <span>üîó Attach Selected Observers</span>
                    </button>
                </div>
            </div>

            <!-- Network Vis -->
            <div class="network-panel" style="flex: 1; min-width: 300px; display: flex; flex-direction: column;">
                <div class="observer-network" style="flex: 1; background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px solid var(--glass-border); padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 250px;">
                    <div id="subject-node" style="padding: 20px 40px; background: var(--primary); color: #000; font-weight: bold; border-radius: 20px; margin-bottom: 40px; box-shadow: 0 0 20px var(--primary); transition: all 0.3s;">
                        Motion Sensor
                    </div>
                    <div id="observers-container" style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; width: 100%;">
                        <div style="color: var(--text-muted); font-style: italic;">No observers attached</div>
                    </div>
                </div>

                <button class="btn-trigger" onclick="Observer.triggerEvent()" style="margin-top: 15px; padding: 15px; background: var(--danger); border: none; border-radius: 10px; color: white; font-weight: bold; font-size: 1.1em; cursor: pointer; box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4); transition: transform 0.2s;">
                    ‚ö° TRIGGER EVENT
                </button>
            </div>
        </div>

        <div class="event-log" style="background: var(--darker); padding: 20px; border-radius: 12px; border: 1px solid var(--glass-border); max-height: 200px; overflow-y: auto;">
            <h5 style="color: var(--text-muted); margin-bottom: 10px; font-size: 0.9em;">üì® Notification Log</h5>
            <div class="event-list" id="event-list" style="display: flex; flex-direction: column-reverse; gap: 8px;">
                <div style="text-align: center; color: var(--text-muted); font-style: italic;">Waiting for events...</div>
            </div>
        </div>

        <div class="pattern-explanation" style="margin-top: 25px;">
            <h5>üí° Pattern Logic</h5>
            <ul>
                <li><strong>Subject:</strong> Maintains a list of `Observer` interface implementations.</li>
                <li><strong>Observer:</strong> Implements `update()`.</li>
                <li><strong>Notify:</strong> Subject iterates through its list and calls `observer.update()`.</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="observer-result"></div>
</div>
<script>
var Observer = {
    selectedDevice: 'motion-sensor',
    subscriptions: [], // {device: 'id', observer: 'TYPE'}

    selectDevice: function(btn, device) {
        document.querySelectorAll('.watch-device').forEach(function(b) {
            b.classList.remove('active');
            b.style.background = 'var(--glass-bg)';
            b.style.borderColor = 'var(--glass-border)';
        });
        btn.classList.add('active');
        btn.style.background = 'rgba(0, 210, 255, 0.15)';
        btn.style.borderColor = 'var(--primary)';

        this.selectedDevice = device;

        // Update Visualization Subject
        var displayNames = {'motion-sensor':'Motion Sensor', 'door-bell':'Door Bell', 'smoke-alarm':'Smoke Alarm'};
        document.getElementById('subject-node').textContent = displayNames[device];

        this.renderNetwork();
    },

    subscribe: function() {
        var checkboxes = document.querySelectorAll('.observer-selection input:checked');
        if (checkboxes.length === 0) {
            PatternDemo.toast('Select observers first!', 'warning');
            return;
        }

        var added = 0;
        checkboxes.forEach(cb => {
            // Avoid duplicates
            if(!this.subscriptions.find(s => s.device === this.selectedDevice && s.observer === cb.value)) {
                this.subscriptions.push({device: this.selectedDevice, observer: cb.value});
                added++;
                // API call
                fetch('/api/patterns/observer/subscribe?deviceId=' + this.selectedDevice + '&observerType=' + cb.value, { method: 'POST' });
            }
        });

        if(added > 0) {
            this.renderNetwork();
            PatternDemo.toast('Attached ' + added + ' observer(s)', 'success');
        } else {
            PatternDemo.toast('Observers already attached', 'info');
        }
    },

    renderNetwork: function() {
        var container = document.getElementById('observers-container');
        var deviceSubs = this.subscriptions.filter(s => s.device === this.selectedDevice);

        if (deviceSubs.length === 0) {
            container.innerHTML = '<div style="color: var(--text-muted); font-style: italic;">No observers attached</div>';
            return;
        }

        var icons = { MOBILE: 'üì±', EMAIL: 'üìß', LOG: 'üìù', SIREN: 'üö®' };

        container.innerHTML = deviceSubs.map(s =>
            '<div class="obs-node" id="obs-' + s.observer + '" style="padding: 10px 15px; background: rgba(255,255,255,0.1); border-radius: 10px; display: flex; flex-direction: column; align-items: center; border: 1px solid var(--text-muted); position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">' +
                '<span style="font-size: 1.5em; margin-bottom: 5px;">' + icons[s.observer] + '</span>' +
                '<span style="font-size: 0.8em;">' + s.observer + '</span>' +
                '<div class="connection-line" style="position: absolute; top: -40px; left: 50%; width: 2px; height: 40px; background: var(--text-muted); z-index: -1;"></div>' +
            '</div>'
        ).join('');
    },

    triggerEvent: function() {
        // Flash Subject
        var subject = document.getElementById('subject-node');
        subject.style.transform = 'scale(1.1)';
        subject.style.boxShadow = '0 0 40px red';
        subject.style.background = 'var(--danger)';
        subject.style.color = '#fff';

        setTimeout(() => {
            subject.style.transform = 'scale(1)';
            subject.style.boxShadow = '0 0 20px var(--primary)';
            subject.style.background = 'var(--primary)';
            subject.style.color = '#000';
        }, 300);

        // Find Subs
        var deviceSubs = this.subscriptions.filter(s => s.device === this.selectedDevice);
        if(deviceSubs.length === 0) {
            PatternDemo.toast('Event triggered, but no one was listening!', 'warning');
            return;
        }

        // Flash Observers Sequentially
        var delay = 200;
        deviceSubs.forEach(s => {
            setTimeout(() => {
                var node = document.querySelector('#obs-' + s.observer);
                if(node) {
                    node.style.background = '#4caf50';
                    node.style.borderColor = '#4caf50';
                    node.style.transform = 'translateY(-5px)';
                    setTimeout(() => {
                        node.style.background = 'rgba(255,255,255,0.1)';
                        node.style.borderColor = 'var(--text-muted)';
                        node.style.transform = 'translateY(0)';
                    }, 300);
                }
            }, delay);
            delay += 150;
        });

        // Log
        var list = document.getElementById('event-list');
        if(list.innerText.includes('Waiting')) list.innerHTML = '';

        var logItem = document.createElement('div');
        logItem.style.cssText = 'padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px; border-left: 3px solid var(--danger); font-family: monospace; font-size: 0.9em; animation: slideIn 0.3s;';
        logItem.innerHTML = '‚ö° [' + new Date().toLocaleTimeString() + '] <strong>' + this.selectedDevice + '</strong> notified ' + deviceSubs.length + ' observers';
        list.prepend(logItem);

        fetch('/api/patterns/observer/trigger?deviceId=' + this.selectedDevice, { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var msg = 'üì° Notification Update:\n' +
                          'Subject: ' + Observer.selectedDevice + '\n' +
                          'Recipients: ' + deviceSubs.map(s => s.observer).join(', ') + '\n' +
                          'Status: All notified successfully.';
                PatternDemo.showResult('observer-result', msg);
            });
    }
};
// Initial render
Observer.selectDevice(document.querySelector('.watch-device.active'), 'motion-sensor');
</script>
