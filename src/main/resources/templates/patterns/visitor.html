<div class="pattern-card" id="pattern-visitor" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">üîç</div>
        <div class="pattern-info">
            <h3>System Auditor</h3>
            <span class="pattern-badge badge-behavioral">Visitor Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Separate an algorithm from the object structure it operates on.
        <strong>Visitor</strong> lets you add new operations (e.g., Export XML, Audit Energy) to existing object structures without modifying them.
    </p>

    <div class="pattern-demo">
        <h4>üéÆ Audit Runner</h4>

        <div class="audit-selector" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <button class="audit-btn" onclick="Visitor.audit('ENERGY', this)" style="display: flex; flex-direction: column; align-items: center; padding: 25px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 16px; color: var(--text); cursor: pointer; transition: all 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <span style="font-size: 3.5em; margin-bottom: 15px; background: rgba(255, 193, 7, 0.1); width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">‚ö°</span>
                <span style="font-size: 1.1em; font-weight: 700;">Energy Audit</span>
                <span style="font-size: 0.85em; color: var(--text-muted); margin-top: 5px;">Calc Power & Cost</span>
            </button>
            <button class="audit-btn" onclick="Visitor.audit('SECURITY', this)" style="display: flex; flex-direction: column; align-items: center; padding: 25px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 16px; color: var(--text); cursor: pointer; transition: all 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <span style="font-size: 3.5em; margin-bottom: 15px; background: rgba(220, 53, 69, 0.1); width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">üîê</span>
                <span style="font-size: 1.1em; font-weight: 700;">Security Check</span>
                <span style="font-size: 0.85em; color: var(--text-muted); margin-top: 5px;">Check Locks & Firmware</span>
            </button>
            <button class="audit-btn" onclick="Visitor.audit('EXPORT', this)" style="display: flex; flex-direction: column; align-items: center; padding: 25px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 16px; color: var(--text); cursor: pointer; transition: all 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <span style="font-size: 3.5em; margin-bottom: 15px; background: rgba(0, 210, 255, 0.1); width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">üìÑ</span>
                <span style="font-size: 1.1em; font-weight: 700;">Export Report</span>
                <span style="font-size: 0.85em; color: var(--text-muted); margin-top: 5px;">Generate JSON/XML</span>
            </button>
        </div>

        <div class="audit-progress" id="audit-progress" style="display:none; padding: 30px; background: var(--darker); border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <h5 style="color: var(--primary); margin-bottom: 20px; font-size: 0.9em; text-transform: uppercase;">üîÑ Visiting Object Structure...</h5>
            <div class="visiting-devices" id="visiting-devices" style="display: flex; flex-direction: column; gap: 12px;"></div>
        </div>

        <div class="audit-results" id="audit-results" style="display:none; padding: 30px; background: var(--darker); border-radius: 16px; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <h5 style="color: var(--success); margin-bottom: 25px; font-size: 0.9em; text-transform: uppercase; display: flex; align-items: center; gap: 10px;">
                <span style="background: rgba(40, 167, 69, 0.2); padding: 5px; border-radius: 4px;">üìä</span> Visitor Report
            </h5>
            <div class="report-summary" id="report-summary" style="display: flex; align-items: center; justify-content: space-between; padding: 25px; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--glass-border);"></div>
            <div class="report-details" id="report-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"></div>
        </div>

        <div class="pattern-explanation">
            <h5>üí° Pattern Logic</h5>
            <ul>
                <li><strong>Element:</strong> `Device` interface has `accept(Visitor v)`.</li>
                <li><strong>Double Dispatch:</strong> `device.accept(v)` calls `v.visit(this)`. type is preserved.</li>
                <li><strong>Visitor:</strong> `EnergyVisitor` implements `visit(Light)`, `visit(Thermo)`, etc.</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="visitor-result"></div>
<script>
var Visitor = {
    audit: function(type, btn) {
        var devices = [
            {icon:'üí°', name:'Living Light', type:'Light'},
            {icon:'üå°Ô∏è', name:'Main Thermostat', type:'Thermostat'},
            {icon:'üì∑', name:'Door Camera', type:'Camera'},
            {icon:'üîí', name:'Front Lock', type:'Lock'}
        ];

        // Reset UI
        document.querySelectorAll('.audit-btn').forEach(b => {
            b.style.borderColor = 'var(--glass-border)';
            b.style.background = 'rgba(255,255,255,0.03)';
        });

        // Highlight active
        if (btn) {
            btn.style.borderColor = 'var(--primary)';
            btn.style.background = 'rgba(0, 210, 255, 0.1)';
        }

        document.getElementById('audit-progress').style.display = 'block';
        document.getElementById('audit-results').style.display = 'none';

        var visitingEl = document.getElementById('visiting-devices');
        visitingEl.innerHTML = '';

        var delay = 0;

        devices.forEach(function(d, i) {
            setTimeout(function() {
                var div = document.createElement('div');
                div.innerHTML = '<div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">' +
                    '<span style="font-size: 1.2em;">' + d.icon + '</span>' +
                    '<span style="flex: 1; font-weight: 500;">' + d.name + '</span>' +
                    '<span style="color: var(--primary); font-family: monospace; font-size: 0.8em;">.accept(' + type + 'Visitor)</span>' +
                    '</div>';
                visitingEl.appendChild(div);

                // Add checkmark shortly after
                setTimeout(() => {
                    div.firstChild.style.background = 'rgba(40, 167, 69, 0.1)';
                    div.firstChild.insertAdjacentHTML('beforeend', '<span>‚úÖ</span>');
                }, 300);

            }, delay);
            delay += 500;
        });

        // Show results
        setTimeout(function() {
            Visitor.showResults(type);
        }, delay + 500);

        // API Call simulation
        fetch('/api/patterns/visitor/audit?type=' + type)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var output = 'üîé Visitor Execution:\n' +
                             '-------------------\n' +
                             'Visitor Type: ' + type + '\n' +
                             'Visited: ' + devices.length + ' elements\n' +
                             'Operation performed on each specific type correctly.';
                PatternDemo.showResult('visitor-result', output);
            });
    },

    showResults: function(type) {
        document.getElementById('audit-progress').style.display = 'none';
        var resultsPanel = document.getElementById('audit-results');
        resultsPanel.style.display = 'block';

        var data = {
            ENERGY: {
                score: '78/100', status: 'Good', color: 'var(--success)',
                items: [
                    { name: 'Living Light', msg: 'Using 15W LED (Optimized)', type: 'success' },
                    { name: 'Main Thermostat', msg: 'High usage in evening', type: 'warning' }
                ]
            },
            SECURITY: {
                score: 'Secure', status: 'Passed', color: 'var(--primary)',
                items: [
                    { name: 'Front Lock', msg: 'Firmware Outdated (v1.2)', type: 'danger' },
                    { name: 'Door Camera', msg: 'Recording Active', type: 'success' }
                ]
            },
            EXPORT: {
                score: 'JSON', status: 'Generated', color: 'var(--text)',
                items: [
                    { name: 'System', msg: 'Exported 4 devices to home_config.json', type: 'info' }
                ]
            }
        };

        var r = data[type];

        // Summary
        document.getElementById('report-summary').innerHTML =
            '<div style="display: flex; align-items: center; gap: 15px;">' +
                '<div style="font-size: 2.5em; font-weight: 700; color: ' + r.color + ';">' + r.score + '</div>' +
                '<div style="font-size: 0.9em; color: var(--text-muted); text-transform: uppercase;">Overall Result</div>' +
            '</div>' +
            '<div style="padding: 5px 15px; background: ' + r.color + '; color: #000; font-weight: bold; border-radius: 20px;">' + r.status + '</div>';

        // Details
        document.getElementById('report-details').innerHTML = r.items.map(function(item) {
            var color = item.type === 'success' ? 'var(--success)' : (item.type === 'warning' ? 'var(--warning)' : (item.type === 'danger' ? 'var(--danger)' : 'var(--info)'));
            return '<div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid ' + color + ';">' +
                '<span style="font-weight: 600;">' + item.name + '</span>' +
                '<span style="color: var(--text-muted);">' + item.msg + '</span>' +
                '</div>';
        }).join('');

        PatternDemo.toast('Audit Completed', 'success');
    }
};
</script>
</div>
