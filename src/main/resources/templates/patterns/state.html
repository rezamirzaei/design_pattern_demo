<div class="pattern-card" id="pattern-state" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">üîÑ</div>
        <div class="pattern-info">
            <h3>Media Player State</h3>
            <span class="pattern-badge badge-behavioral">State Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Change an object's behavior when its internal state changes. The object will appear to change its class.
        (e.g., Pressing "Play" does different things depending on whether the player is currently Stopped, Playing, or Paused).
    </p>

    <div class="pattern-demo">
        <h4>üéÆ State Machine Demo</h4>

        <div class="player-display" style="padding: 25px; background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 20px; margin-bottom: 25px; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <div class="player-screen" id="player-screen" style="text-align: center; padding: 40px; background: rgba(0,0,0,0.3); border-radius: 15px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.05);">
                <div class="screen-icon" id="screen-icon" style="font-size: 5em; margin-bottom: 15px; filter: drop-shadow(0 0 15px var(--primary));">‚èπÔ∏è</div>
                <div class="screen-status" id="screen-status" style="font-size: 1.4em; font-weight: 700; color: var(--primary); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px;">STOPPED</div>
                <div class="screen-track" style="color: var(--text-muted); font-size: 0.9em;">üéµ Chill Beats Mix</div>
            </div>

            <div class="player-progress" style="margin-bottom: 25px;">
                <div class="progress-bar" style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                    <div class="progress-fill" id="progress-fill" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.3s;"></div>
                </div>
                <div class="progress-time" style="display: flex; justify-content: space-between; font-size: 0.8em; color: var(--text-muted); margin-top: 5px;">
                    <span id="time-current">0:00</span>
                    <span id="time-total">3:45</span>
                </div>
            </div>

            <div class="player-controls" style="display: flex; justify-content: center; gap: 20px;">
                <button class="ctrl-btn" onclick="State.action('stop')" style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text); font-size: 1.2em; cursor: pointer; transition: all 0.2s;">‚èπÔ∏è</button>
                <button class="ctrl-btn" onclick="State.action('prev')" style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text); font-size: 1.2em; cursor: pointer; transition: all 0.2s;">‚èÆÔ∏è</button>
                <button class="ctrl-btn main" onclick="State.action('playPause')" id="btn-play" style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--accent)); border: none; color: #fff; font-size: 2em; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(0, 210, 255, 0.4); transform: scale(1.1);">‚ñ∂Ô∏è</button>
                <button class="ctrl-btn" onclick="State.action('next')" style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text); font-size: 1.2em; cursor: pointer; transition: all 0.2s;">‚è≠Ô∏è</button>
                <button class="ctrl-btn" onclick="State.action('mute')" style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text); font-size: 1.2em; cursor: pointer; transition: all 0.2s;">üîä</button>
            </div>
        </div>

        <div class="state-diagram" style="padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--glass-border);">
            <h5 style="color: var(--text-muted); margin-bottom: 20px; text-transform: uppercase; font-size: 0.9em; text-align: center;">State Transition Diagram</h5>
            <div class="diagram" style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <div class="state-node" id="sn-stopped" style="padding: 15px 25px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 10px; transition: all 0.3s; opacity: 0.5;">
                    ‚èπÔ∏è Stopped
                </div>
                <div class="state-arrow" style="color: var(--text-muted);">‚ûú</div>
                <div class="state-node" id="sn-playing" style="padding: 15px 25px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 10px; transition: all 0.3s; opacity: 0.5;">
                    ‚ñ∂Ô∏è Playing
                </div>
                <div class="state-arrow" style="color: var(--text-muted);">‚ûú</div>
                <div class="state-node" id="sn-paused" style="padding: 15px 25px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 10px; transition: all 0.3s; opacity: 0.5;">
                    ‚è∏Ô∏è Paused
                </div>
            </div>
        </div>

        <div class="pattern-explanation" style="margin-top: 25px;">
            <h5>üí° Pattern Logic</h5>
            <ul>
                <li><strong>Context (Player):</strong> Delegates calls to the current State object.</li>
                <li><strong>State (Interface):</strong> `play()`, `stop()`, `next()`.</li>
                <li><strong>Concrete States:</strong> `PlayingState`, `PausedState`, `StoppedState`. Each implements the methods differently.</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="state-result"></div>
</div>
<script>
var State = {
    current: 'STOPPED',
    progress: 0,
    interval: null,

    action: function(action) {
        var oldState = this.current;

        // Simulating State Pattern Logic
        if (action === 'playPause') {
            if (this.current === 'PLAYING') {
                this.transitionTo('PAUSED');
                this.stopProgress();
            } else {
                this.transitionTo('PLAYING');
                this.startProgress();
            }
        } else if (action === 'stop') {
            this.transitionTo('STOPPED');
            this.progress = 0;
            this.stopProgress();
        }

        this.updateUI();

        fetch('/api/patterns/state/transition?action=' + action, {method:'POST'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var output = 'üîÑ State Transition\n' +
                             '-------------------\n' +
                             'From: ' + oldState + '\n' +
                             'To: ' + State.current + '\n' +
                             'Context Behavior Updated.';

                PatternDemo.showResult('state-result', output);
            });
    },

    transitionTo: function(newState) {
        this.current = newState;
        PatternDemo.toast('State: ' + newState, 'info');
    },

    updateUI: function() {
        var icons = {STOPPED:'‚èπÔ∏è', PLAYING:'‚ñ∂Ô∏è', PAUSED:'‚è∏Ô∏è'};
        var playBtn = {STOPPED:'‚ñ∂Ô∏è', PLAYING:'‚è∏Ô∏è', PAUSED:'‚ñ∂Ô∏è'};

        document.getElementById('screen-icon').textContent = icons[this.current];
        document.getElementById('screen-status').textContent = this.current;
        document.getElementById('btn-play').textContent = playBtn[this.current];

        document.getElementById('progress-fill').style.width = this.progress + '%';

        var mins = Math.floor((this.progress * 225) / 100 / 60);
        var secs = Math.floor((this.progress * 225) / 100) % 60;
        document.getElementById('time-current').textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;

        // Update Diagram Highlights
        document.querySelectorAll('.state-node').forEach(function(n) {
            n.style.opacity = '0.5';
            n.style.background = 'rgba(255,255,255,0.05)';
            n.style.borderColor = 'var(--glass-border)';
            n.style.boxShadow = 'none';
        });

        var currentNode = document.getElementById('sn-' + this.current.toLowerCase());
        if(currentNode) {
            currentNode.style.opacity = '1';
            currentNode.style.background = 'rgba(0, 210, 255, 0.2)';
            currentNode.style.borderColor = 'var(--primary)';
            currentNode.style.boxShadow = '0 0 15px rgba(0, 210, 255, 0.3)';
            currentNode.style.transform = 'scale(1.05)';
        }
    },

    startProgress: function() {
        var self = this;
        if(this.interval) clearInterval(this.interval);
        this.interval = setInterval(function() {
            self.progress += 1; // 1% every 100ms
            if (self.progress >= 100) {
                self.progress = 0;
                // Auto loop
            }
            self.updateUI();
        }, 100);
    },

    stopProgress: function() {
        if (this.interval) clearInterval(this.interval);
    }
};
document.addEventListener('DOMContentLoaded', function() { State.updateUI(); });
</script>
</div>
