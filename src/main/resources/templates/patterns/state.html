<div class="pattern-card" id="pattern-state" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">üîÑ</div>
        <div class="pattern-info">
            <h3>Media Player State</h3>
            <span class="pattern-badge badge-behavioral">State Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Change an object's behavior when its internal state changes. The object will appear to change its class.
        (e.g., Pressing "Play" does different things depending on whether the player is currently Stopped, Playing, or Paused).
    </p>

    <div class="pattern-demo">
        <h4>üéÆ State Machine Demo</h4>

        <div class="player-display" style="padding: 30px; background: linear-gradient(135deg, #121212, #1e1e2f); border-radius: 20px; margin-bottom: 30px; border: 1px solid var(--glass-border); box-shadow: 0 20px 50px rgba(0,0,0,0.5);">
            <div class="player-screen" id="player-screen" style="text-align: center; padding: 40px; background: rgba(0,0,0,0.3); border-radius: 16px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.05); position: relative; overflow: hidden; min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <div class="screen-icon" id="screen-icon" style="font-size: 6em; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(0,0,0,0.5)); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">‚èπÔ∏è</div>
                <div class="screen-content" style="z-index: 2;">
                    <div class="screen-status" id="screen-status" style="font-size: 1.5em; font-weight: 800; color: var(--primary); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 3px; text-shadow: 0 0 10px rgba(0, 210, 255, 0.3);">STOPPED</div>
                    <div class="screen-track" style="color: var(--text-muted); font-size: 1em; font-family: 'Consolas', monospace;">Waiting for input...</div>
                </div>
                <div class="visualizer" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 60px; display: flex; align-items: flex-end; justify-content: center; gap: 3px; opacity: 0.2;">
                    <!-- Simple CSS Visualizer simulation -->
                    <div style="width: 5px; height: 20%; background: var(--primary);"></div>
                    <div style="width: 5px; height: 40%; background: var(--primary);"></div>
                    <div style="width: 5px; height: 60%; background: var(--primary);"></div>
                    <div style="width: 5px; height: 30%; background: var(--primary);"></div>
                    <div style="width: 5px; height: 50%; background: var(--primary);"></div>
                </div>
            </div>

            <div class="player-progress" style="margin-bottom: 30px;">
                <div class="progress-bar" style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; cursor: pointer;">
                    <div class="progress-fill" id="progress-fill" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.1s linear; box-shadow: 0 0 10px var(--primary);"></div>
                </div>
                <div class="progress-time" style="display: flex; justify-content: space-between; font-size: 0.85em; color: var(--text-muted); margin-top: 8px; font-family: monospace;">
                    <span id="time-current">0:00</span>
                    <span id="time-total">3:45</span>
                </div>
            </div>

            <div class="player-controls" style="display: flex; justify-content: center; gap: 25px; align-items: center;">
                <button class="ctrl-btn" onclick="State.action('prev')" style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text); font-size: 1.2em; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">‚èÆÔ∏è</button>
                <button class="ctrl-btn" onclick="State.action('stop')" style="width: 60px; height: 60px; border-radius: 50%; background: rgba(220, 53, 69, 0.1); border: 1px solid var(--danger); color: var(--danger); font-size: 1.4em; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">‚èπÔ∏è</button>
                <button class="ctrl-btn main" onclick="State.action('playPause')" id="btn-play" style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); border: none; color: #000; font-size: 2.5em; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 30px rgba(0, 210, 255, 0.4); transform: scale(1); transition: all 0.2s;">‚ñ∂Ô∏è</button>
                <button class="ctrl-btn" onclick="State.action('next')" style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text); font-size: 1.2em; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">‚è≠Ô∏è</button>
            </div>
        </div>

        <div class="state-diagram" style="padding: 30px; background: var(--darker); border-radius: 16px; margin-bottom: 25px; border: 1px solid var(--glass-border);">
            <h5 style="color: var(--text-muted); margin-bottom: 25px; text-transform: uppercase; font-size: 0.9em; text-align: center; letter-spacing: 1px;">Current Internal State</h5>
            <div class="diagram" style="display: flex; align-items: center; justify-content: center; gap: 30px; flex-wrap: wrap;">
                <div class="state-node" id="sn-stopped" style="padding: 15px 30px; background: rgba(220, 53, 69, 0.15); border: 1px solid var(--danger); border-radius: 30px; transition: all 0.3s; opacity: 0.4; font-weight: 600; color: var(--danger);">
                    ‚èπÔ∏è Stopped
                </div>
                <div class="state-arrow" style="color: var(--text-muted); font-size: 1.2em;">‚áÑ</div>
                <div class="state-node" id="sn-playing" style="padding: 15px 30px; background: rgba(40, 167, 69, 0.15); border: 1px solid #28a745; border-radius: 30px; transition: all 0.3s; opacity: 0.4; font-weight: 600; color: #28a745;">
                    ‚ñ∂Ô∏è Playing
                </div>
                <div class="state-arrow" style="color: var(--text-muted); font-size: 1.2em;">‚áÑ</div>
                <div class="state-node" id="sn-paused" style="padding: 15px 30px; background: rgba(255, 193, 7, 0.15); border: 1px solid var(--warning); border-radius: 30px; transition: all 0.3s; opacity: 0.4; font-weight: 600; color: var(--warning);">
                    ‚è∏Ô∏è Paused
                </div>
            </div>
        </div>

        <div class="pattern-explanation">
            <h5>üí° Pattern Logic</h5>
            <ul>
                <li><strong>Context (Player):</strong> Delegates calls to the current State object.</li>
                <li><strong>State (Interface):</strong> `play()`, `stop()`, `next()`.</li>
                <li><strong>Concrete States:</strong> `PlayingState`, `PausedState`, `StoppedState`. Each implements the methods differently.</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="state-result"></div>
<script>
var State = {
    current: 'STOPPED',
    progress: 0,
    interval: null,

    action: function(action) {
        var oldState = this.current;

        // Simulating State Pattern Logic
        if (action === 'playPause') {
            if (this.current === 'PLAYING') {
                this.transitionTo('PAUSED');
                this.stopProgress();
            } else {
                this.transitionTo('PLAYING');
                this.startProgress();
            }
        } else if (action === 'stop') {
            this.transitionTo('STOPPED');
            this.progress = 0;
            this.stopProgress();
        }

        this.updateUI();

        fetch('/api/patterns/state/transition?action=' + action, {method:'POST'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var output = 'üîÑ State Transition\n' +
                             '-------------------\n' +
                             'From: ' + oldState + '\n' +
                             'To: ' + State.current + '\n' +
                             'Context Behavior Updated.';

                PatternDemo.showResult('state-result', output);
            });
    },

    transitionTo: function(newState) {
        this.current = newState;
        PatternDemo.toast('State: ' + newState, 'info');
    },

    updateUI: function() {
        var icons = {STOPPED:'‚èπÔ∏è', PLAYING:'‚ñ∂Ô∏è', PAUSED:'‚è∏Ô∏è'};
        var playBtn = {STOPPED:'‚ñ∂Ô∏è', PLAYING:'‚è∏Ô∏è', PAUSED:'‚ñ∂Ô∏è'};

        document.getElementById('screen-icon').textContent = icons[this.current];
        document.getElementById('screen-status').textContent = this.current;
        document.getElementById('btn-play').textContent = playBtn[this.current];

        document.getElementById('progress-fill').style.width = this.progress + '%';

        var mins = Math.floor((this.progress * 225) / 100 / 60);
        var secs = Math.floor((this.progress * 225) / 100) % 60;
        document.getElementById('time-current').textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;

        // Update Diagram Highlights
        document.querySelectorAll('.state-node').forEach(function(n) {
            n.style.opacity = '0.5';
            n.style.background = 'rgba(255,255,255,0.05)';
            n.style.borderColor = 'var(--glass-border)';
            n.style.boxShadow = 'none';
        });

        var currentNode = document.getElementById('sn-' + this.current.toLowerCase());
        if(currentNode) {
            currentNode.style.opacity = '1';
            currentNode.style.background = 'rgba(0, 210, 255, 0.2)';
            currentNode.style.borderColor = 'var(--primary)';
            currentNode.style.boxShadow = '0 0 15px rgba(0, 210, 255, 0.3)';
            currentNode.style.transform = 'scale(1.05)';
        }
    },

    startProgress: function() {
        var self = this;
        if(this.interval) clearInterval(this.interval);
        this.interval = setInterval(function() {
            self.progress += 1; // 1% every 100ms
            if (self.progress >= 100) {
                self.progress = 0;
                // Auto loop
            }
            self.updateUI();
        }, 100);
    },

    stopProgress: function() {
        if (this.interval) clearInterval(this.interval);
    }
};
document.addEventListener('DOMContentLoaded', function() { State.updateUI(); });
</script>
</div>
