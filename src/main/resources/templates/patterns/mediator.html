<div class="pattern-card" id="pattern-mediator" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">üéõÔ∏è</div>
        <div class="pattern-info">
            <h3>Smart Home Hub (Mediator)</h3>
            <span class="pattern-badge badge-behavioral">Mediator Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">The <strong>Smart Home Hub</strong> coordinates communication between all devices. Devices don't talk directly to each other - they notify the hub, which then coordinates the response.</p>
    <div class="pattern-demo">
        <h4>üéÆ Trigger Events Through Hub</h4>
        <div class="hub-visualization">
            <div class="devices-ring">
                <div class="device-node" id="node-motion"><span>üö∂</span>Motion</div>
                <div class="device-node" id="node-door"><span>üö™</span>Door</div>
                <div class="device-node" id="node-light"><span>üí°</span>Light</div>
                <div class="device-node" id="node-camera"><span>üì∑</span>Camera</div>
                <div class="device-node" id="node-alarm"><span>üö®</span>Alarm</div>
                <div class="device-node" id="node-thermo"><span>üå°Ô∏è</span>Thermo</div>
            </div>
            <div class="hub-center">
                <div class="hub-icon">üéõÔ∏è</div>
                <div class="hub-label">Smart Hub</div>
            </div>
        </div>
        <div class="event-triggers">
            <h5>‚ö° Trigger Events</h5>
            <div class="trigger-btns">
                <button class="trigger-btn" onclick="Mediator.trigger('motion','MOTION_DETECTED')">
                    <span class="tb-icon">üö∂</span>
                    <span class="tb-event">Motion Detected</span>
                    <span class="tb-response">‚Üí Lights ON, Camera Record</span>
                </button>
                <button class="trigger-btn" onclick="Mediator.trigger('door','DOOR_OPENED')">
                    <span class="tb-icon">üö™</span>
                    <span class="tb-event">Door Opened</span>
                    <span class="tb-response">‚Üí Check alarm, Notify</span>
                </button>
                <button class="trigger-btn" onclick="Mediator.trigger('smoke','SMOKE_DETECTED')">
                    <span class="tb-icon">üî•</span>
                    <span class="tb-event">Smoke Detected</span>
                    <span class="tb-response">‚Üí Alarm ON, Lights ON, Call 911</span>
                </button>
                <button class="trigger-btn" onclick="Mediator.trigger('temp','TEMP_HIGH')">
                    <span class="tb-icon">üå°Ô∏è</span>
                    <span class="tb-event">Temperature High</span>
                    <span class="tb-response">‚Üí AC ON, Notify</span>
                </button>
            </div>
        </div>
        <div class="coordination-log">
            <h5>üìã Hub Coordination Log</h5>
            <div class="log-content" id="mediator-log">
                <div class="log-placeholder">Trigger an event to see hub coordination...</div>
            </div>
        </div>
        <div class="pattern-explanation">
            <h5>üí° How Mediator Works:</h5>
            <ul>
                <li><strong>Mediator</strong> (Hub) knows all colleagues (devices)</li>
                <li><strong>Colleagues</strong> (Devices) only know the mediator, not each other</li>
                <li>Device sends event to hub ‚Üí Hub notifies relevant devices</li>
                <li>Reduces coupling: N*(N-1) connections ‚Üí N connections</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="mediator-result"></div>
</div>
<script>
var Mediator = {
    logCount: 0,
    trigger: function(source, event) {
        this.logCount++;
        // Animate hub
        document.querySelector('.hub-center').classList.add('pulse');
        setTimeout(function() { document.querySelector('.hub-center').classList.remove('pulse'); }, 500);
        // Define responses
        var responses = {
            'MOTION_DETECTED': [{device:'light',action:'ON'},{device:'camera',action:'RECORD'}],
            'DOOR_OPENED': [{device:'alarm',action:'CHECK'},{device:'camera',action:'SNAPSHOT'}],
            'SMOKE_DETECTED': [{device:'alarm',action:'ON'},{device:'light',action:'ON'},{device:'door',action:'UNLOCK'}],
            'TEMP_HIGH': [{device:'thermo',action:'COOL'},{device:'alarm',action:'NOTIFY'}]
        };
        var actions = responses[event] || [];
        // Animate affected devices
        document.querySelectorAll('.device-node').forEach(function(n) { n.classList.remove('active','source'); });
        document.getElementById('node-' + source).classList.add('source');
        var delay = 300;
        actions.forEach(function(a) {
            setTimeout(function() {
                var node = document.getElementById('node-' + a.device);
                if (node) node.classList.add('active');
            }, delay);
            delay += 200;
        });
        // Update log
        var logEl = document.getElementById('mediator-log');
        if (this.logCount === 1) logEl.innerHTML = '';
        var logEntry = document.createElement('div');
        logEntry.className = 'mlog-entry';
        logEntry.innerHTML = '<div class="mlog-source">üì° ' + source + ' ‚Üí Hub: ' + event + '</div>' +
            '<div class="mlog-responses">' + actions.map(function(a) { return '‚Ü™Ô∏è Hub ‚Üí ' + a.device + ': ' + a.action; }).join('<br>') + '</div>';
        logEl.insertBefore(logEntry, logEl.firstChild);
        fetch('/api/patterns/mediator/notify?sourceDeviceId=' + source + '&event=' + event, {method:'POST'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                PatternDemo.showResult('mediator-result', 'Hub received: ' + event + ' from ' + source + '\n\nHub coordinated responses:\n' + actions.map(function(a) { return '‚Ä¢ ' + a.device + ' ‚Üí ' + a.action; }).join('\n') + '\n\nDevices communicate through hub, not directly.\n\n' + JSON.stringify(data, null, 2));
                PatternDemo.toast('Hub coordinated ' + actions.length + ' responses', 'success');
            });
    }
};
</script>
<style>
.hub-visualization { position: relative; height: 280px; margin-bottom: 25px; }
.devices-ring { position: absolute; width: 100%; height: 100%; }
.device-node { position: absolute; display: flex; flex-direction: column; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; font-size: 0.8em; transition: all 0.3s; }
.device-node span { font-size: 1.8em; margin-bottom: 4px; }
.device-node.source { border-color: #ffc107; background: rgba(255,193,7,0.2); }
.device-node.active { border-color: #00d2ff; background: rgba(0,210,255,0.2); box-shadow: 0 0 15px rgba(0,210,255,0.4); }
#node-motion { top: 10%; left: 50%; transform: translateX(-50%); }
#node-door { top: 30%; right: 10%; }
#node-light { top: 70%; right: 15%; }
#node-camera { bottom: 5%; left: 50%; transform: translateX(-50%); }
#node-alarm { top: 70%; left: 15%; }
#node-thermo { top: 30%; left: 10%; }
.hub-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; padding: 25px; background: linear-gradient(135deg, rgba(0,210,255,0.2), rgba(58,123,213,0.2)); border: 2px solid #00d2ff; border-radius: 50%; transition: all 0.3s; }
.hub-center.pulse { transform: translate(-50%, -50%) scale(1.1); box-shadow: 0 0 30px rgba(0,210,255,0.5); }
.hub-icon { font-size: 2.5em; }
.hub-label { font-weight: 600; color: #00d2ff; }
.event-triggers { margin-bottom: 20px; }
.event-triggers h5 { color: #888; margin-bottom: 12px; }
.trigger-btns { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
.trigger-btn { display: flex; align-items: center; gap: 12px; padding: 15px; background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; cursor: pointer; text-align: left; transition: all 0.3s; }
.trigger-btn:hover { background: rgba(0,210,255,0.1); border-color: rgba(0,210,255,0.4); }
.tb-icon { font-size: 1.8em; }
.tb-event { font-weight: 500; display: block; }
.tb-response { font-size: 0.75em; color: #888; display: block; }
.coordination-log { padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; max-height: 150px; overflow-y: auto; }
.coordination-log h5 { color: #888; margin-bottom: 10px; }
.log-placeholder { color: #666; font-style: italic; }
.mlog-entry { padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #00d2ff; }
.mlog-source { font-weight: 500; margin-bottom: 5px; }
.mlog-responses { font-size: 0.85em; color: #888; }
@media (max-width: 768px) { .trigger-btns { grid-template-columns: 1fr; } }
</style>
</div>
