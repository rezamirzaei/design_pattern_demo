<div class="pattern-card" id="pattern-memento" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">ğŸ“¸</div>
        <div class="pattern-info">
            <h3>State Snapshots</h3>
            <span class="pattern-badge badge-behavioral">Memento Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Capture and restore an object's internal state without violating encapsulation.
        The <strong>Memento Pattern</strong> saves "checkpoints" (e.g., Night Mode, Morning Setup) that you can revert to anytime.
    </p>

    <div class="pattern-demo">
        <h4>ğŸ® Time Machine</h4>

        <div class="current-state" style="padding: 25px; background: var(--darker); border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <h5 style="color: var(--primary); margin-bottom: 20px; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px;">Current Configuration (Originator)</h5>
            <div class="state-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                <div class="state-device" style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--glass-border);">
                    <span class="sd-icon" style="font-size: 2.5em; display: block; margin-bottom: 15px;">ğŸ’¡</span>
                    <select class="form-input" id="state-lights" style="width: 100%; text-align: center; padding: 8px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: var(--text);">
                        <option value="ON">ON (100%)</option>
                        <option value="DIM">DIM (30%)</option>
                        <option value="OFF">OFF</option>
                    </select>
                </div>
                <div class="state-device" style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--glass-border);">
                    <span class="sd-icon" style="font-size: 2.5em; display: block; margin-bottom: 15px;">ğŸŒ¡ï¸</span>
                    <select class="form-input" id="state-thermo" style="width: 100%; text-align: center; padding: 8px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: var(--text);">
                        <option value="22">22Â°C (Comfort)</option>
                        <option value="20">20Â°C (Eco)</option>
                        <option value="18">18Â°C (Sleep)</option>
                    </select>
                </div>
                <div class="state-device" style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--glass-border);">
                    <span class="sd-icon" style="font-size: 2.5em; display: block; margin-bottom: 15px;">ğŸ”’</span>
                    <select class="form-input" id="state-locks" style="width: 100%; text-align: center; padding: 8px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: var(--text);">
                        <option value="LOCKED">LOCKED</option>
                        <option value="UNLOCKED">UNLOCKED</option>
                    </select>
                </div>
                <div class="state-device" style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--glass-border);">
                    <span class="sd-icon" style="font-size: 2.5em; display: block; margin-bottom: 15px;">ğŸš¨</span>
                    <select class="form-input" id="state-alarm" style="width: 100%; text-align: center; padding: 8px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: var(--text);">
                        <option value="OFF">Disarmed</option>
                        <option value="HOME">Home Mode</option>
                        <option value="AWAY">Away Mode</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="snapshot-actions" style="display: flex; gap: 15px; margin-bottom: 25px;">
            <input type="text" id="snapshot-name" class="form-input" placeholder="Snapshot Name (e.g. Party Prep)" style="flex: 1; padding: 12px 20px; border-radius: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white;">
            <button class="btn-primary" onclick="Memento.save()" style="padding: 0 30px; font-weight: 600; border-radius: 10px;">ğŸ“¸ Capture State</button>
        </div>

        <div class="snapshots-list" style="background: var(--darker); padding: 25px; border-radius: 16px; border: 1px solid var(--glass-border);">
            <h5 style="color: var(--text-muted); margin-bottom: 20px; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px;">ğŸ’¾ Saved Checkpoints (Caretaker)</h5>
            <div class="snapshots" id="snapshots-list" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Default Presets -->
                <div class="snapshot-item" onclick="Memento.restore('Morning Default')" style="display: flex; align-items: center; gap: 20px; padding: 18px; background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <span class="si-icon" style="font-size: 2em; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px;">ğŸŒ…</span>
                    <div style="flex: 1;">
                        <span class="si-name" style="font-weight: 600; display: block; font-size: 1.1em; color: var(--text); margin-bottom: 4px;">Morning Default</span>
                        <span class="si-desc" style="font-size: 0.85em; color: var(--text-muted);">22Â°C, Unlocked, Lights ON</span>
                    </div>
                    <button class="action-btn" style="padding: 8px 16px; font-size: 0.85em; background: rgba(0, 210, 255, 0.1); border: 1px solid var(--primary); color: var(--primary); border-radius: 20px;">âª RESTORE</button>
                </div>

                <div class="snapshot-item" onclick="Memento.restore('Night Default')" style="display: flex; align-items: center; gap: 20px; padding: 18px; background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border); border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                    <span class="si-icon" style="font-size: 2em; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px;">ğŸŒ™</span>
                    <div style="flex: 1;">
                        <span class="si-name" style="font-weight: 600; display: block; font-size: 1.1em; color: var(--text); margin-bottom: 4px;">Night Default</span>
                        <span class="si-desc" style="font-size: 0.85em; color: var(--text-muted);">18Â°C, Locked, Lights OFF</span>
                    </div>
                    <button class="action-btn" style="padding: 8px 16px; font-size: 0.85em; background: rgba(0, 210, 255, 0.1); border: 1px solid var(--primary); color: var(--primary); border-radius: 20px;">âª RESTORE</button>
                </div>
            </div>
        </div>

        <div class="pattern-explanation" style="margin-top: 25px;">
            <h5>ğŸ’¡ Pattern Logic</h5>
            <ul>
                <li><strong>Originator (SmartHome):</strong> Creates a Memento containing a snapshot of its internal state.</li>
                <li><strong>Memento:</strong> Passive object storing the state (Lights, Thermo, etc.).</li>
                <li><strong>Caretaker:</strong> Holds the history of Mementos (The list below).</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="memento-result"></div>
</div>
<script>
var Memento = {
    snapshots: [],
    save: function() {
        var nameInput = document.getElementById('snapshot-name');
        var name = nameInput.value || 'Snapshot #' + (this.snapshots.length + 1);

        var state = {
            lights: document.getElementById('state-lights').value,
            thermo: document.getElementById('state-thermo').value,
            locks: document.getElementById('state-locks').value,
            alarm: document.getElementById('state-alarm').value
        };

        var snapshot = {name: name, state: state, time: new Date(), sceneId: null};
        this.snapshots.push(snapshot);
        this.updateList();
        nameInput.value = '';

        PatternDemo.showResult('memento-result', 'ğŸ’¾ State Captured: "' + name + '"\n' +
            '----------------------\n' +
            'Internal State Preserved:\n' +
            JSON.stringify(state, null, 2));

        PatternDemo.toast('Snapshot Saved', 'success');

        fetch('/api/patterns/memento/save?name=' + encodeURIComponent(name), {method:'POST'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data && data.sceneId) {
                    snapshot.sceneId = data.sceneId;
                }
            })
            .catch(function() {
                // Keep UI snapshot even if backend call fails
            });
    },

    restore: function(preset) {
        var state;
        var sceneId = null;
        var sceneName = null;

        // Check if custom or preset
        if(typeof preset === 'string') {
            var presets = {
                'Morning Default': {lights:'ON',thermo:'22',locks:'UNLOCKED',alarm:'OFF'},
                'Night Default': {lights:'OFF',thermo:'18',locks:'LOCKED',alarm:'HOME'},
                'Away Default': {lights:'OFF',thermo:'18',locks:'LOCKED',alarm:'AWAY'}
            };
            state = presets[preset];
            sceneName = preset;
        } else {
            state = preset?.state; // Custom snapshot object passed directly
            sceneId = preset?.sceneId || null;
            sceneName = preset?.name || null;
        }

        if (!state) return;

        // Apply state
        document.getElementById('state-lights').value = state.lights;
        document.getElementById('state-thermo').value = state.thermo;
        document.getElementById('state-locks').value = state.locks;
        document.getElementById('state-alarm').value = state.alarm;

        // Flash visualization
        var grid = document.querySelector('.state-grid');
        grid.style.transition = 'background 0.3s';
        grid.style.background = 'rgba(0, 255, 136, 0.1)';
        setTimeout(() => grid.style.background = 'transparent', 300);

        PatternDemo.showResult('memento-result', 'âª State Restored from Memento\n' +
            '----------------------\n' +
            'Applied Configuration:\n' +
            JSON.stringify(state, null, 2));

        PatternDemo.toast('State Restored', 'info');

        if (sceneId) {
            fetch('/api/patterns/memento/restore?snapshotId=' + encodeURIComponent(sceneId), {method:'POST'});
        } else if (sceneName) {
            fetch('/api/patterns/memento/restore?sceneName=' + encodeURIComponent(sceneName), {method:'POST'});
        }
    },

    updateList: function() {
        var list = document.getElementById('snapshots-list');
        // Remove old custom items
        list.querySelectorAll('.custom-snap').forEach(e => e.remove());

        this.snapshots.forEach((s, i) => {
            var el = document.createElement('div');
            el.className = 'snapshot-item custom-snap';
            el.onclick = function() { Memento.restore(s) };
            el.style.cssText = 'display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(0, 210, 255, 0.1); border: 1px solid var(--primary); border-radius: 10px; cursor: pointer; transition: all 0.3s; animation: slideIn 0.3s;';

            el.innerHTML =
                '<span class="si-icon" style="font-size: 1.5em;">ğŸ“¸</span>' +
                '<div style="flex: 1;">' +
                    '<span class="si-name" style="font-weight: 600; display: block; color: var(--primary);">' + s.name + '</span>' +
                    '<span class="si-desc" style="font-size: 0.8em; color: var(--text-muted);">' + s.time.toLocaleTimeString() + '</span>' +
                '</div>' +
                '<button class="action-btn" style="padding: 5px 12px; font-size: 0.8em;">âª RESTORE</button>';

            list.appendChild(el);
        });
    }
};
</script>
</div>
