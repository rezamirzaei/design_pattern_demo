<div class="pattern-card" id="pattern-memento" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">üì∏</div>
        <div class="pattern-info">
            <h3>Home State Snapshot</h3>
            <span class="pattern-badge badge-behavioral">Memento Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">Save <strong>snapshots of your home state</strong> and restore them later. Perfect for saving "before bedtime" settings and restoring them tomorrow!</p>
    <div class="pattern-demo">
        <h4>üéÆ Manage State Snapshots</h4>
        <div class="current-state">
            <h5>üè† Current Home State</h5>
            <div class="state-grid">
                <div class="state-device">
                    <span class="sd-icon">üí°</span>
                    <span class="sd-name">Lights</span>
                    <select class="state-select" id="state-lights">
                        <option value="ON">ON (70%)</option>
                        <option value="DIM">DIM (30%)</option>
                        <option value="OFF">OFF</option>
                    </select>
                </div>
                <div class="state-device">
                    <span class="sd-icon">üå°Ô∏è</span>
                    <span class="sd-name">Thermo</span>
                    <select class="state-select" id="state-thermo">
                        <option value="22">22¬∞C</option>
                        <option value="20">20¬∞C</option>
                        <option value="18">18¬∞C</option>
                    </select>
                </div>
                <div class="state-device">
                    <span class="sd-icon">üîí</span>
                    <span class="sd-name">Locks</span>
                    <select class="state-select" id="state-locks">
                        <option value="LOCKED">Locked</option>
                        <option value="UNLOCKED">Unlocked</option>
                    </select>
                </div>
                <div class="state-device">
                    <span class="sd-icon">üö®</span>
                    <span class="sd-name">Alarm</span>
                    <select class="state-select" id="state-alarm">
                        <option value="OFF">Off</option>
                        <option value="HOME">Home Mode</option>
                        <option value="AWAY">Away Mode</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="snapshot-actions">
            <div class="save-snapshot">
                <input type="text" id="snapshot-name" class="form-input" placeholder="Snapshot name" value="My Snapshot">
                <button class="btn-save" onclick="Memento.save()">üì∏ Save Snapshot</button>
            </div>
        </div>
        <div class="snapshots-list">
            <h5>üìã Saved Snapshots</h5>
            <div class="snapshots" id="snapshots-list">
                <div class="snapshot-item" onclick="Memento.restore('morning')">
                    <span class="si-icon">üåÖ</span>
                    <span class="si-name">Morning Setup</span>
                    <span class="si-time">Built-in</span>
                    <button class="si-restore">‚è™ Restore</button>
                </div>
                <div class="snapshot-item" onclick="Memento.restore('night')">
                    <span class="si-icon">üåô</span>
                    <span class="si-name">Goodnight</span>
                    <span class="si-time">Built-in</span>
                    <button class="si-restore">‚è™ Restore</button>
                </div>
                <div class="snapshot-item" onclick="Memento.restore('away')">
                    <span class="si-icon">üöó</span>
                    <span class="si-name">Away Mode</span>
                    <span class="si-time">Built-in</span>
                    <button class="si-restore">‚è™ Restore</button>
                </div>
            </div>
        </div>
        <div class="pattern-explanation">
            <h5>üí° How Memento Works:</h5>
            <ul>
                <li><strong>Originator</strong> (Home) creates memento with its current state</li>
                <li><strong>Memento</strong> stores the state snapshot (lights, thermo, etc.)</li>
                <li><strong>Caretaker</strong> keeps track of saved mementos</li>
                <li>Restoration applies memento's state back to originator</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="memento-result"></div>
</div>
<script>
var Memento = {
    snapshots: [],
    save: function() {
        var name = document.getElementById('snapshot-name').value || 'Snapshot';
        var state = {
            lights: document.getElementById('state-lights').value,
            thermo: document.getElementById('state-thermo').value,
            locks: document.getElementById('state-locks').value,
            alarm: document.getElementById('state-alarm').value
        };
        this.snapshots.push({name: name, state: state, time: new Date()});
        this.updateList();
        fetch('/api/patterns/memento/save?sceneName=' + encodeURIComponent(name), {method:'POST'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                PatternDemo.showResult('memento-result', 'Snapshot saved: ' + name + '\n\nState captured:\n‚Ä¢ Lights: ' + state.lights + '\n‚Ä¢ Thermo: ' + state.thermo + '\n‚Ä¢ Locks: ' + state.locks + '\n‚Ä¢ Alarm: ' + state.alarm + '\n\n' + JSON.stringify(data, null, 2));
                PatternDemo.toast('Saved: ' + name, 'success');
            });
    },
    restore: function(preset) {
        var presets = {
            morning: {lights:'ON',thermo:'22',locks:'UNLOCKED',alarm:'OFF'},
            night: {lights:'OFF',thermo:'18',locks:'LOCKED',alarm:'HOME'},
            away: {lights:'OFF',thermo:'18',locks:'LOCKED',alarm:'AWAY'}
        };
        var state = presets[preset];
        if (!state) return;
        document.getElementById('state-lights').value = state.lights;
        document.getElementById('state-thermo').value = state.thermo;
        document.getElementById('state-locks').value = state.locks;
        document.getElementById('state-alarm').value = state.alarm;
        fetch('/api/patterns/memento/restore?sceneName=' + preset, {method:'POST'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                PatternDemo.showResult('memento-result', 'Restored: ' + preset + '\n\nState restored:\n‚Ä¢ Lights: ' + state.lights + '\n‚Ä¢ Thermo: ' + state.thermo + '\n‚Ä¢ Locks: ' + state.locks + '\n‚Ä¢ Alarm: ' + state.alarm + '\n\n' + JSON.stringify(data, null, 2));
                PatternDemo.toast('Restored: ' + preset, 'success');
            });
    },
    updateList: function() {
        var list = document.getElementById('snapshots-list');
        var customHtml = this.snapshots.map(function(s, i) {
            return '<div class="snapshot-item custom" onclick="Memento.restoreCustom(' + i + ')">' +
                '<span class="si-icon">üì∏</span>' +
                '<span class="si-name">' + s.name + '</span>' +
                '<span class="si-time">' + s.time.toLocaleTimeString() + '</span>' +
                '<button class="si-restore">‚è™ Restore</button></div>';
        }).join('');
        // Keep built-in and add custom
        var builtIn = list.querySelectorAll('.snapshot-item:not(.custom)');
        var builtInHtml = Array.from(builtIn).map(function(el) { return el.outerHTML; }).join('');
        list.innerHTML = builtInHtml + customHtml;
    },
    restoreCustom: function(index) {
        var s = this.snapshots[index];
        document.getElementById('state-lights').value = s.state.lights;
        document.getElementById('state-thermo').value = s.state.thermo;
        document.getElementById('state-locks').value = s.state.locks;
        document.getElementById('state-alarm').value = s.state.alarm;
        PatternDemo.toast('Restored: ' + s.name, 'success');
    }
};
</script>
<style>
.current-state { padding: 20px; background: rgba(0,0,0,0.2); border-radius: 15px; margin-bottom: 20px; }
.current-state h5 { color: #00d2ff; margin-bottom: 15px; }
.state-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
.state-device { display: flex; flex-direction: column; align-items: center; gap: 8px; }
.sd-icon { font-size: 2em; }
.sd-name { font-size: 0.85em; color: #888; }
.state-select { padding: 8px 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: white; text-align: center; cursor: pointer; }
.snapshot-actions { margin-bottom: 20px; }
.save-snapshot { display: flex; gap: 10px; }
.save-snapshot .form-input { flex: 1; }
.btn-save { padding: 10px 20px; background: linear-gradient(90deg, #00d2ff, #3a7bd5); border: none; border-radius: 8px; color: white; cursor: pointer; white-space: nowrap; }
.snapshots-list h5 { color: #888; margin-bottom: 12px; }
.snapshots { display: flex; flex-direction: column; gap: 10px; }
.snapshot-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; cursor: pointer; transition: all 0.3s; }
.snapshot-item:hover { background: rgba(0,210,255,0.1); border-color: rgba(0,210,255,0.3); }
.snapshot-item.custom { border-color: rgba(40,167,69,0.3); }
.si-icon { font-size: 1.5em; }
.si-name { flex: 1; font-weight: 500; }
.si-time { font-size: 0.8em; color: #888; }
.si-restore { padding: 6px 12px; background: rgba(0,210,255,0.2); border: none; border-radius: 6px; color: #00d2ff; cursor: pointer; }
@media (max-width: 768px) { .state-grid { grid-template-columns: repeat(2, 1fr); } }
</style>
</div>
