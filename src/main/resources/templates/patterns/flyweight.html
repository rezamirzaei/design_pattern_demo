<div class="pattern-card" id="pattern-flyweight" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">ü™∂</div>
        <div class="pattern-info">
            <h3>Device Type Cache</h3>
            <span class="pattern-badge badge-structural">Flyweight Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">Share <strong>common device data</strong> across many instances to save memory. Device types (icons, capabilities, protocols) are shared - only unique data (name, location) is stored per device.</p>
    <div class="pattern-demo">
        <h4>üéÆ Memory Optimization Demo</h4>
        <div class="memory-comparison">
            <div class="memory-box without">
                <h5>‚ùå Without Flyweight</h5>
                <div class="device-instances">
                    <div class="instance">üí° Light #1 <span class="instance-data">+ icon, caps, protocol</span></div>
                    <div class="instance">üí° Light #2 <span class="instance-data">+ icon, caps, protocol</span></div>
                    <div class="instance">üí° Light #3 <span class="instance-data">+ icon, caps, protocol</span></div>
                    <div class="instance">üå°Ô∏è Thermo #1 <span class="instance-data">+ icon, caps, protocol</span></div>
                    <div class="instance">üå°Ô∏è Thermo #2 <span class="instance-data">+ icon, caps, protocol</span></div>
                </div>
                <div class="memory-total">Memory: <span class="memory-bad">~500 KB</span></div>
            </div>
            <div class="memory-box with">
                <h5>‚úÖ With Flyweight</h5>
                <div class="shared-types">
                    <div class="shared-type">üí° LightType <span class="shared-data">(shared)</span></div>
                    <div class="shared-type">üå°Ô∏è ThermoType <span class="shared-data">(shared)</span></div>
                </div>
                <div class="device-instances">
                    <div class="instance light">Light #1 ‚Üí üí°</div>
                    <div class="instance light">Light #2 ‚Üí üí°</div>
                    <div class="instance light">Light #3 ‚Üí üí°</div>
                    <div class="instance thermo">Thermo #1 ‚Üí üå°Ô∏è</div>
                    <div class="instance thermo">Thermo #2 ‚Üí üå°Ô∏è</div>
                </div>
                <div class="memory-total">Memory: <span class="memory-good">~125 KB</span></div>
            </div>
        </div>
        <div class="flyweight-stats">
            <h5>üìä Current System Stats</h5>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="fw-types">4</span>
                    <span class="stat-label">Shared Types</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="fw-instances">50+</span>
                    <span class="stat-label">Device Instances</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="fw-saved">75%</span>
                    <span class="stat-label">Memory Saved</span>
                </div>
            </div>
            <button class="btn-demo" onclick="Flyweight.demo()">üîÑ Refresh Stats</button>
        </div>
        <div class="pattern-explanation">
            <h5>üí° How Flyweight Works:</h5>
            <ul>
                <li><strong>Intrinsic State</strong> (shared): icon, capabilities, protocol - stored in flyweight</li>
                <li><strong>Extrinsic State</strong> (unique): name, location, status - stored per instance</li>
                <li><strong>Flyweight Factory</strong> creates/reuses flyweight objects</li>
                <li>Many devices share same type object instead of duplicating data</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="flyweight-result"></div>
</div>
<script>
var Flyweight = {
    demo: function() {
        fetch('/api/patterns/flyweight/stats')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                document.getElementById('fw-types').textContent = data.sharedTypes || 4;
                document.getElementById('fw-instances').textContent = (data.instances || 50) + '+';
                document.getElementById('fw-saved').textContent = (data.memorySaved || 75) + '%';
                PatternDemo.showResult('flyweight-result', 'Flyweight Pattern Statistics\n\nShared Device Types: ' + (data.sharedTypes || 4) + '\n  ‚Ä¢ Light Type (icon, RGB capability, Zigbee protocol)\n  ‚Ä¢ Thermostat Type (icon, temp range, WiFi protocol)\n  ‚Ä¢ Camera Type (icon, resolution, RTSP protocol)\n  ‚Ä¢ Lock Type (icon, PIN capability, Z-Wave protocol)\n\nDevice Instances: ' + (data.instances || 50) + '+\nMemory Without Flyweight: ~500 KB\nMemory With Flyweight: ~125 KB\nMemory Saved: 75%\n\n' + JSON.stringify(data, null, 2));
                PatternDemo.toast('Stats refreshed', 'success');
            });
    }
};
</script>
<style>
.memory-comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
.memory-box { padding: 20px; border-radius: 15px; }
.memory-box.without { background: rgba(220,53,69,0.1); border: 2px solid rgba(220,53,69,0.3); }
.memory-box.with { background: rgba(40,167,69,0.1); border: 2px solid rgba(40,167,69,0.3); }
.memory-box h5 { margin-bottom: 15px; }
.device-instances { display: flex; flex-direction: column; gap: 6px; margin-bottom: 15px; }
.instance { padding: 8px 12px; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 0.85em; }
.instance-data { color: #dc3545; font-size: 0.75em; }
.shared-types { margin-bottom: 10px; padding: 10px; background: rgba(0,210,255,0.1); border-radius: 8px; }
.shared-type { padding: 5px 0; }
.shared-data { color: #00d2ff; font-size: 0.8em; }
.memory-total { font-weight: 600; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
.memory-bad { color: #dc3545; }
.memory-good { color: #28a745; }
.flyweight-stats { padding: 20px; background: rgba(0,0,0,0.2); border-radius: 15px; }
.flyweight-stats h5 { color: #00d2ff; margin-bottom: 15px; }
.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; }
.stat-item { text-align: center; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 10px; }
.stat-value { display: block; font-size: 2em; font-weight: bold; color: #00d2ff; }
.stat-label { font-size: 0.8em; color: #888; }
.btn-demo { width: 100%; padding: 12px; background: linear-gradient(90deg, #00d2ff, #3a7bd5); border: none; border-radius: 10px; color: white; cursor: pointer; }
</style>
</div>
