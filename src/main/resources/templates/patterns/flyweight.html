<div class="pattern-card" id="pattern-flyweight" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">ğŸª¶</div>
        <div class="pattern-info">
            <h3>Type Sharing (Memory Saver)</h3>
            <span class="pattern-badge badge-structural">Flyweight Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Share common data across thousands of objects to save RAM.
        The <strong>Flyweight Pattern</strong> stores intrinsic state (e.g., icons, protocols) in shared shared objects, while extrinsic state (e.g., location, status) remains in the individual instance.
    </p>

    <div class="pattern-demo">
        <h4>ğŸ® Memory Optimization Visualizer</h4>

        <div class="memory-comparison" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 30px;">
            <div class="memory-box without" style="padding: 25px; border-radius: 16px; background: rgba(220,53,69,0.05); border: 1px dashed rgba(220,53,69,0.4); box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                <h5 style="color: #ff6b6b; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-weight: 700; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px;">
                    <span style="background: rgba(220,53,69,0.2); padding: 5px; border-radius: 4px;">âŒ</span> Standard Approach
                </h5>
                <div class="device-instances" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                    <div class="instance" style="padding: 12px 15px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 0.9em; display: flex; justify-content: space-between; border: 1px solid rgba(220,53,69,0.2);">
                        <span style="font-weight: 600;">ğŸ’¡ Light #1</span>
                        <span style="color: #ff6b6b; font-size: 0.8em; font-family: monospace;">[Icon, RGB, Zigbee]</span>
                    </div>
                    <div class="instance" style="padding: 12px 15px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 0.9em; display: flex; justify-content: space-between; border: 1px solid rgba(220,53,69,0.2);">
                        <span style="font-weight: 600;">ğŸ’¡ Light #2</span>
                        <span style="color: #ff6b6b; font-size: 0.8em; font-family: monospace;">[Icon, RGB, Zigbee]</span>
                    </div>
                    <div class="instance" style="padding: 12px 15px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 0.9em; display: flex; justify-content: space-between; border: 1px solid rgba(220,53,69,0.2);">
                        <span style="font-weight: 600;">ğŸ’¡ Light #3</span>
                        <span style="color: #ff6b6b; font-size: 0.8em; font-family: monospace;">[Icon, RGB, Zigbee]</span>
                    </div>
                </div>
                <div class="memory-total" style="padding-top: 15px; border-top: 1px dashed rgba(220,53,69,0.3); font-weight: 700; color: #ff6b6b; text-align: right; font-size: 1.1em;">
                    Usage: ~500 KB <span style="font-size: 0.7em; opacity: 0.8; font-weight: 400;">(Duplication)</span>
                </div>
            </div>

            <div class="memory-box with" style="padding: 25px; border-radius: 16px; background: rgba(40,167,69,0.05); border: 1px solid rgba(40,167,69,0.4); box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                <h5 style="color: #28a745; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-weight: 700; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px;">
                    <span style="background: rgba(40,167,69,0.2); padding: 5px; border-radius: 4px;">âœ…</span> Flyweight Pattern
                </h5>

                <div class="shared-types" style="margin-bottom: 20px; padding: 12px; background: rgba(40,167,69,0.15); border-radius: 10px; text-align: center; border: 1px solid rgba(40,167,69,0.3);">
                    <div style="font-size: 0.75em; color: #28a745; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">SHARED INTRINSIC STATE</div>
                    <div style="font-family: monospace; color: #fff; font-size: 0.9em;">[Icon, RGB, Zigbee]</div>
                </div>

                <div class="device-instances" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                    <div class="instance" style="padding: 12px 15px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(40,167,69,0.2);">
                        <span style="font-weight: 600;">ğŸ’¡ Light #1</span>
                        <span style="font-size: 1.2em; color: #28a745; font-weight: bold;">â†—</span>
                    </div>
                    <div class="instance" style="padding: 12px 15px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(40,167,69,0.2);">
                        <span style="font-weight: 600;">ğŸ’¡ Light #2</span>
                        <span style="font-size: 1.2em; color: #28a745; font-weight: bold;">â†—</span>
                    </div>
                    <div class="instance" style="padding: 12px 15px; background: rgba(0,0,0,0.2); border-radius: 10px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(40,167,69,0.2);">
                        <span style="font-weight: 600;">ğŸ’¡ Light #3</span>
                        <span style="font-size: 1.2em; color: #28a745; font-weight: bold;">â†—</span>
                    </div>
                </div>
                <div class="memory-total" style="padding-top: 15px; border-top: 1px dashed rgba(40,167,69,0.3); font-weight: 700; color: #28a745; text-align: right; font-size: 1.1em;">
                    Usage: ~125 KB <span style="font-size: 0.7em; opacity: 0.8; font-weight: 400;">(Shared)</span>
                </div>
            </div>
        </div>

        <div class="flyweight-stats" style="padding: 30px; background: var(--darker); border-radius: 16px; border: 1px solid var(--glass-border); margin-top: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <h5 style="color: var(--primary); margin-bottom: 20px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px;">ğŸ“Š Real-time Memory Profiler</h5>
            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px;">
                <div class="stat-item" style="text-align: center; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <span class="stat-value" id="fw-types" style="display: block; font-size: 2.5em; font-weight: 700; color: var(--primary); margin-bottom: 5px;">4</span>
                    <span class="stat-label" style="font-size: 0.8em; color: var(--text-muted); text-transform: uppercase;">Unique Types</span>
                </div>
                <div class="stat-item" style="text-align: center; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <span class="stat-value" id="fw-instances" style="display: block; font-size: 2.5em; font-weight: 700; color: var(--accent); margin-bottom: 5px;">50+</span>
                    <span class="stat-label" style="font-size: 0.8em; color: var(--text-muted); text-transform: uppercase;">Device Objects</span>
                </div>
                <div class="stat-item" style="text-align: center; padding: 20px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid var(--glass-border);">
                    <span class="stat-value" id="fw-saved" style="display: block; font-size: 2.5em; font-weight: 700; color: var(--success); margin-bottom: 5px;">75%</span>
                    <span class="stat-label" style="font-size: 0.8em; color: var(--text-muted); text-transform: uppercase;">RAM Saved</span>
                </div>
            </div>
            <button class="btn-primary" onclick="Flyweight.demo()" style="width: 100%; padding: 15px; font-weight: 700; border-radius: 12px; font-size: 1.1em;">
                <span>ğŸ”„ Simulate Large Scale Generation</span>
            </button>
        </div>

        <div class="pattern-explanation" style="margin-top: 25px;">
            <h5>ğŸ’¡ Pattern Logic</h5>
            <ul>
                <li><strong>Intrinsic State (Shared):</strong> Type, Icon, Protocol, Capabilities. (Immutable)</li>
                <li><strong>Extrinsic State (Unique):</strong> Coordinate, ID, Current Status. (Passed in)</li>
                <li><strong>Factory:</strong> Maintains the Cache/Map of existing Flyweights.</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="flyweight-result"></div>
<script>
var Flyweight = {
    demo: function() {
        PatternDemo.showResult('flyweight-result', 'ğŸ”„ Generating 10,000 devices...\n...');

        fetch('/api/patterns/flyweight/stats')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                // Animate numbers
                Flyweight.animateValue('fw-types', 4, data.sharedTypes || 4, 1000);
                Flyweight.animateValue('fw-instances', 50, data.instances || 10000, 1500);

                document.getElementById('fw-saved').textContent = (data.memorySaved || 90) + '%';

                PatternDemo.showResult('flyweight-result', 'ğŸ“Š Analysis Complete\n' +
                    '--------------------------\n' +
                    'Total Devices Created: ' + (data.instances || 10000) + '\n' +
                    'Actual Objects in Memory: ' + (data.sharedTypes || 4) + ' (Types) + ' + (data.instances || 10000) + ' (Lightweight Pointers)\n' +
                    'Memory Without Pattern: ~500 MB\n' +
                    'Memory With Pattern: ~12 MB\n' +
                    '--------------------------\n' +
                    'âœ… OPTIMIZATION SUCCESSFUL');

                PatternDemo.toast('Memory Stats Optimized', 'success');
            });
    },
    animateValue: function(id, start, end, duration) {
        var range = end - start;
        var current = start;
        var increment = end > start ? 100 : -100;
        if (Math.abs(range) < 100) increment = end > start ? 1 : -1;
        var stepTime = Math.abs(Math.floor(duration / (range / increment)));
        var obj = document.getElementById(id);
        var timer = setInterval(function() {
            current += increment;
            if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                current = end;
                clearInterval(timer);
            }
            obj.textContent = current.toLocaleString();
        }, stepTime);
    }
};
</script>
</div>
