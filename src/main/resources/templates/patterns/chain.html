<div class="pattern-card" id="pattern-chain" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">‚õìÔ∏è</div>
        <div class="pattern-info">
            <h3>Alert Response Chain</h3>
            <span class="pattern-badge badge-behavioral">Chain of Responsibility</span>
        </div>
    </div>
    <p class="pattern-desc">
        Process requests through a chain of handlers. Each handler decides either to consume the request or pass it to the next link.
        Highly effective for <strong>Security Alert Systems</strong> where different threat levels require different responses.
    </p>

    <div class="pattern-demo">
        <h4>üéÆ Threat Simulation</h4>

        <div class="alert-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 25px;">
            <button class="alert-btn info" onclick="Chain.alert('INFO','Motion in garden')" style="background: rgba(0,210,255,0.1); border-color: var(--primary);">
                <span class="ab-icon">‚ÑπÔ∏è</span>
                <span class="ab-level">INFO</span>
                <span class="ab-example">Motion</span>
            </button>
            <button class="alert-btn warning" onclick="Chain.alert('WARNING','Unrecognized face')" style="background: rgba(255,193,7,0.1); border-color: var(--warning);">
                <span class="ab-icon">‚ö†Ô∏è</span>
                <span class="ab-level">WARNING</span>
                <span class="ab-example">Unknown Face</span>
            </button>
            <button class="alert-btn critical" onclick="Chain.alert('CRITICAL','Window breach')" style="background: rgba(220,53,69,0.1); border-color: var(--danger);">
                <span class="ab-icon">üö®</span>
                <span class="ab-level">CRITICAL</span>
                <span class="ab-example">Breach</span>
            </button>
            <button class="alert-btn emergency" onclick="Chain.alert('EMERGENCY','Smoke Alarm')" style="background: rgba(255,100,0,0.1); border-color: #ff6600;">
                <span class="ab-icon">üî•</span>
                <span class="ab-level">EMERGENCY</span>
                <span class="ab-example">Fire</span>
            </button>
        </div>

        <div class="chain-visualization" style="padding: 30px 20px; background: rgba(0,0,0,0.2); border-radius: 15px; border: 1px solid var(--glass-border); margin-bottom: 20px;">
            <h5 style="color: var(--text-muted); margin-bottom: 20px; text-align: center; text-transform: uppercase; font-size: 0.8em;">Processing Pipeline</h5>
            <div class="chain-handlers" id="chain-handlers" style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <!-- Handlers -->
                <div class="handler" id="handler-log" style="position: relative;">
                    <span class="h-icon">üìù</span>
                    <span class="h-name">Logger</span>
                    <div class="h-indicator"></div>
                </div>
                <div class="chain-arrow">‚û°</div>

                <div class="handler" id="handler-notify" style="position: relative;">
                    <span class="h-icon">üì±</span>
                    <span class="h-name">Notifier</span>
                    <div class="h-indicator"></div>
                </div>
                <div class="chain-arrow">‚û°</div>

                <div class="handler" id="handler-alarm" style="position: relative;">
                    <span class="h-icon">üö®</span>
                    <span class="h-name">Siren</span>
                    <div class="h-indicator"></div>
                </div>
                <div class="chain-arrow">‚û°</div>

                <div class="handler" id="handler-emergency" style="position: relative;">
                    <span class="h-icon">üöí</span>
                    <span class="h-name">911 Ops</span>
                    <div class="h-indicator"></div>
                </div>
            </div>
        </div>

        <div class="alert-log" style="padding: 20px; background: var(--darker); border-radius: 12px; max-height: 250px; overflow-y: auto; border: 1px solid var(--glass-border);">
            <h5 style="color: var(--primary); margin-bottom: 10px; font-size: 0.9em;">üìã System Audit Log</h5>
            <div class="log-entries" id="alert-log-entries" style="display: flex; flex-direction: column; gap: 8px;">
                <div class="log-placeholder" style="text-align: center; color: var(--text-muted); padding: 20px; font-style: italic;">
                    Waiting for events...
                </div>
            </div>
        </div>

        <div class="pattern-explanation" style="margin-top: 25px;">
            <h5>üí° Pattern Logic</h5>
            <ul>
                <li><strong>Abstract Handler:</strong> Defines `setNext(Handler)` and `handle(Request)`.</li>
                <li><strong>Concrete Handlers:</strong> `Logger`, `Notifier`, `Siren`. Each checks if it should act, then calls `next.handle()`.</li>
                <li><strong>Flow:</strong> INFO triggers only Logger. WARNING triggers Logger->Notifier. CRITICAL triggers all.</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="chain-result"></div>
</div>
<script>
var Chain = {
    alertCount: 0,
    alert: function(level, message) {
        this.alertCount++;
        var handlers = {
            INFO: ['log'],
            WARNING: ['log', 'notify'],
            CRITICAL: ['log', 'notify', 'alarm'],
            EMERGENCY: ['log', 'notify', 'alarm', 'emergency']
        };
        var activeHandlers = handlers[level] || [];

        // Reset all handlers visualization
        document.querySelectorAll('.handler').forEach(function(h) {
            h.style.borderColor = 'var(--glass-border)';
            h.style.background = 'var(--glass-bg)';
            h.style.transform = 'scale(1)';
            h.querySelector('.h-indicator').style.opacity = '0';
        });

        // Animate chain flow
        var delay = 0;
        activeHandlers.forEach(function(h) {
            setTimeout(function() {
                var el = document.getElementById('handler-' + h);
                el.style.borderColor = 'var(--primary)';
                el.style.background = 'rgba(0, 210, 255, 0.15)';
                el.style.transform = 'scale(1.1)';
                el.querySelector('.h-indicator').style.opacity = '1';
                setTimeout(() => el.style.transform = 'scale(1)', 200);
            }, delay);
            delay += 400; // sequential delay
        });

        // Add to log
        var logEl = document.getElementById('alert-log-entries');
        if (logEl.querySelector('.log-placeholder')) logEl.innerHTML = '';

        var colors = {INFO: 'var(--primary)', WARNING: 'var(--warning)', CRITICAL: 'var(--danger)', EMERGENCY: '#ff6600'};
        var entry = document.createElement('div');
        entry.style.cssText = 'padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid ' + colors[level] + '; font-family: monospace; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease-out;';

        entry.innerHTML = '<span style="color: var(--text-muted); font-size: 0.8em;">' + new Date().toLocaleTimeString() + '</span>' +
            '<span style="font-weight: 700; color: ' + colors[level] + ';">[' + level + ']</span>' +
            '<span style="flex: 1;">' + message + '</span>';

        logEl.prepend(entry);

        // API Call
        fetch('/api/patterns/chain/alert?deviceId=sensor&level=' + level + '&message=' + encodeURIComponent(message), {method:'POST'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var output = '‚õìÔ∏è Chain Execution Trace:\n' +
                             '----------------------\n' +
                             'Event: ' + level + ' - ' + message + '\n' +
                             'Path: ' + activeHandlers.map(h => h.toUpperCase()).join(' -> ') + '\n' +
                             'Result: Handled successfully';

                PatternDemo.showResult('chain-result', output);
                PatternDemo.toast('Alert Processed: ' + level, level === 'INFO' ? 'info' : 'error');
            });
    }
};
</script>
</div>
