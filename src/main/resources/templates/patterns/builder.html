<div class="pattern-card" id="pattern-builder" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">ğŸ”§</div>
        <div class="pattern-info">
            <h3>Automation Builder</h3>
            <span class="pattern-badge badge-creational">Builder Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Construct complex <strong>Automation Rules</strong> step-by-step. The <strong>Builder Pattern</strong> separates the construction of a complex object from its representation.
    </p>

    <div class="pattern-demo">
        <h4>ğŸ® Rule Construction Kit</h4>

        <div class="pd-builder-steps">
            <!-- Step 1 -->
            <div class="pd-panel pd-builder-step">
                <div class="pd-step-num">1</div>
                <div class="pd-step-body">
                    <label class="pd-form-label">Rule Identifier</label>
                    <input type="text" id="builder-name" class="pd-input" value="Morning Routine" placeholder="Name your automation">
                </div>
            </div>

            <!-- Step 2 -->
            <div class="pd-panel pd-builder-step">
                <div class="pd-step-num">2</div>
                <div class="pd-step-body">
                    <label class="pd-form-label">Trigger (When)</label>
                    <div class="pd-pill-row">
                        <button class="pd-pill pd-pill--primary active" data-trigger="time:07:00" onclick="Builder.selectTrigger(this)">â° 7:00 AM</button>
                        <button class="pd-pill" data-trigger="time:22:00" onclick="Builder.selectTrigger(this)">ğŸŒ™ 10:00 PM</button>
                        <button class="pd-pill" data-trigger="motion" onclick="Builder.selectTrigger(this)">ğŸš¶ Motion</button>
                        <button class="pd-pill" data-trigger="door:open" onclick="Builder.selectTrigger(this)">ğŸšª Door Open</button>
                        <button class="pd-pill" data-trigger="sunset" onclick="Builder.selectTrigger(this)">ğŸŒ… Sunset</button>
                    </div>
                </div>
            </div>

            <!-- Step 3 -->
            <div class="pd-panel pd-builder-step">
                <div class="pd-step-num">3</div>
                <div class="pd-step-body">
                    <label class="pd-form-label pd-panel-header--warning">Conditions (If)</label>
                    <div class="pd-pill-row">
                        <label class="pd-toggle"><input type="checkbox" id="cond-home" checked><span>ğŸ  Someone home</span></label>
                        <label class="pd-toggle"><input type="checkbox" id="cond-dark"><span>ğŸŒ‘ It's dark</span></label>
                        <label class="pd-toggle"><input type="checkbox" id="cond-weekday"><span>ğŸ“… Weekday</span></label>
                    </div>
                </div>
            </div>

            <!-- Step 4 -->
            <div class="pd-panel pd-builder-step">
                <div class="pd-step-num">4</div>
                <div class="pd-step-body">
                    <label class="pd-form-label pd-panel-header--success">Actions (Then)</label>
                    <div class="pd-pill-row">
                        <label class="pd-toggle"><input type="checkbox" id="act-lights" checked><span>ğŸ’¡ Lights On</span></label>
                        <label class="pd-toggle"><input type="checkbox" id="act-thermo"><span>ğŸŒ¡ï¸ Set Temp</span></label>
                        <label class="pd-toggle"><input type="checkbox" id="act-lock"><span>ğŸ”’ Lock Door</span></label>
                        <label class="pd-toggle"><input type="checkbox" id="act-notify"><span>ğŸ“± Notify</span></label>
                    </div>
                </div>
            </div>
        </div>

        <div class="pd-blueprint">
            <h5 class="pd-small-heading" style="text-align:center">ğŸ“‹ Logic Blueprint</h5>
            <div id="builder-preview" class="pd-blueprint-content">
                <strong>Morning Routine</strong>: WHEN â° 7:00 AM, IF ğŸ  Someone home -> ğŸ’¡ Lights On
            </div>
        </div>

        <div class="pd-btn-row" style="margin-bottom:25px">
            <button class="pd-btn-action" style="flex:1" onclick="Builder.build()">ğŸ”¨ Construct Rule</button>
            <button class="pd-pill" onclick="Builder.preset('random')">ğŸ² Random</button>
        </div>

        <hr class="pd-divider-h">
        <h5 class="pd-small-heading">âš¡ Quick Presets</h5>
        <div class="pd-pill-row">
            <button class="pd-pill" onclick="Builder.preset('morning')">ğŸŒ… Morning</button>
            <button class="pd-pill" onclick="Builder.preset('night')">ğŸŒ™ Goodnight</button>
            <button class="pd-pill" onclick="Builder.preset('away')">ğŸ›¡ï¸ Away</button>
        </div>

        <div class="pattern-explanation">
            <h5>ğŸ’¡ Pattern Logic</h5>
            <ul>
                <li><strong>Director:</strong> (User UI) Guides the sequence (Step 1 â†’ 2 â†’ 3 â†’ 4).</li>
                <li><strong>Builder:</strong> Accumulates configuration state (<code>AutomationRule.Builder</code>).</li>
                <li><strong>Product:</strong> The final complex <code>AutomationRule</code> object is only created when <code>build()</code> is called.</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="builder-result"></div>
<script>
var Builder = {
    selectedTrigger: 'time:07:00',
    selectTrigger: function(btn) {
        document.querySelectorAll('#pattern-builder .pd-pill[data-trigger]').forEach(function(b) {
            b.classList.remove('active', 'pd-pill--primary');
        });
        btn.classList.add('active', 'pd-pill--primary');
        this.selectedTrigger = btn.dataset.trigger;
        this.updatePreview();
    },
    updatePreview: function() {
        var name = document.getElementById('builder-name').value || 'My Rule';
        var trigger = this.selectedTrigger;
        var triggerText = {'time:07:00':'â° 7:00 AM','time:22:00':'ğŸŒ™ 10:00 PM','motion':'ğŸš¶ Motion','door:open':'ğŸšª Door Open','sunset':'ğŸŒ… Sunset'}[trigger] || trigger;
        var conditions = [];
        if (document.getElementById('cond-home').checked) conditions.push('ğŸ  Someone home');
        if (document.getElementById('cond-dark').checked) conditions.push('ğŸŒ‘ It\'s dark');
        if (document.getElementById('cond-weekday').checked) conditions.push('ğŸ“… Weekday');
        var actions = [];
        if (document.getElementById('act-lights').checked) actions.push('ğŸ’¡ Lights On');
        if (document.getElementById('act-thermo').checked) actions.push('ğŸŒ¡ï¸ Set Temp');
        if (document.getElementById('act-lock').checked) actions.push('ğŸ”’ Lock Door');
        if (document.getElementById('act-notify')?.checked) actions.push('ğŸ“± Notify');
        var preview = '<strong>' + name + '</strong>: WHEN ' + triggerText;
        if (conditions.length > 0) preview += ', IF <span style="color:var(--warning)">' + conditions.join(' & ') + '</span>';
        if (actions.length > 0) preview += ' â†’ <span style="color:var(--success)">' + actions.join(', ') + '</span>';
        else preview += ' â†’ (No Action)';
        document.getElementById('builder-preview').innerHTML = preview;
    },
    build: function() {
        var name = document.getElementById('builder-name').value;
        var conditions = [];
        if (document.getElementById('cond-home').checked) conditions.push('HOME');
        if (document.getElementById('cond-dark').checked) conditions.push('DARK');
        if (document.getElementById('cond-weekday').checked) conditions.push('WEEKDAY');
        var actions = [];
        if (document.getElementById('act-lights').checked) actions.push('LIGHTS_ON');
        if (document.getElementById('act-thermo').checked) actions.push('THERMO_SET');
        if (document.getElementById('act-lock').checked) actions.push('LOCK_DOOR');
        if (document.getElementById('act-notify')?.checked) actions.push('NOTIFY');
        var trigger = this.selectedTrigger;
        var conditionText = conditions.length > 0 ? conditions.join(' AND ') : 'NONE';
        var actionText = actions.length > 0 ? actions.join(', ') : 'NONE';
        PatternDemo.showResult('builder-result', 'ğŸ—ï¸ Builder constructing rule...');
        fetch('/api/patterns/builder/rule?name=' + encodeURIComponent(name || 'My Rule') + '&trigger=' + encodeURIComponent(trigger) + '&condition=' + encodeURIComponent(conditionText) + '&action=' + encodeURIComponent(actionText), { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                PatternDemo.showResult('builder-result', 'âœ… Rule Built\nName: ' + (data.name || name) + '\nTrigger: ' + (data.trigger || trigger) + '\nCondition: ' + conditionText + '\nAction: ' + actionText);
                PatternDemo.toast('Rule Built Successfully', 'success');
            })
            .catch(function(e) { PatternDemo.showResult('builder-result', 'Error: ' + e.message); });
    },
    preset: function(type) {
        if (type === 'random') type = ['morning', 'night', 'away'][Math.floor(Math.random() * 3)];
        var presets = {
            morning: {name:'Morning Routine',trigger:'time:07:00',lights:true,thermo:true,home:true,dark:false,weekday:true},
            night: {name:'Goodnight',trigger:'time:22:00',lights:false,lock:true,home:true,dark:true,weekday:false},
            away: {name:'Away Mode',trigger:'door:open',lock:true,notify:true,home:false,dark:false,weekday:false}
        };
        var p = presets[type]; if(!p) return;
        document.getElementById('builder-name').value = p.name;
        var triggerBtn = Array.from(document.querySelectorAll('#pattern-builder .pd-pill[data-trigger]')).find(function(b) { return b.dataset.trigger === p.trigger; });
        if (triggerBtn) this.selectTrigger(triggerBtn);
        document.getElementById('cond-home').checked = p.home || false;
        document.getElementById('cond-dark').checked = p.dark || false;
        document.getElementById('cond-weekday').checked = p.weekday || false;
        document.getElementById('act-lights').checked = p.lights || false;
        document.getElementById('act-thermo').checked = p.thermo || false;
        document.getElementById('act-lock').checked = p.lock || false;
        if (document.getElementById('act-notify')) document.getElementById('act-notify').checked = p.notify || false;
        this.updatePreview();
        PatternDemo.toast('Preset: ' + p.name, 'info');
    }
};
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('#pattern-builder input').forEach(function(el) {
        el.addEventListener('change', function() { Builder.updatePreview(); });
        el.addEventListener('input', function() { Builder.updatePreview(); });
    });
    Builder.updatePreview();
});
</script>
</div>
