<div class="pattern-card" id="pattern-builder" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">ğŸ”§</div>
        <div class="pattern-info">
            <h3>Automation Builder</h3>
            <span class="pattern-badge badge-creational">Builder Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Construct complex <strong>Automation Rules</strong> step-by-step. The <strong>Builder Pattern</strong> separates the construction of a complex object (a rule with triggers, conditions, and actions) from its representation, allowing the same construction process to create various representations.
    </p>

    <div class="pattern-demo">
        <h4>ğŸ® Rule Construction Kit</h4>

        <div class="builder-steps">
            <!-- Step 1 -->
            <div class="builder-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <label>Rule Name</label>
                    <input type="text" id="builder-name" class="form-input" value="Morning Routine" placeholder="Name your automation">
                </div>
            </div>

            <!-- Step 2 -->
            <div class="builder-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <label>Trigger (When)</label>
                    <div class="trigger-options">
                        <button class="trigger-btn active" data-trigger="time:07:00" onclick="Builder.selectTrigger(this)">â° 7:00 AM</button>
                        <button class="trigger-btn" data-trigger="time:22:00" onclick="Builder.selectTrigger(this)">ğŸŒ™ 10:00 PM</button>
                        <button class="trigger-btn" data-trigger="motion" onclick="Builder.selectTrigger(this)">ğŸš¶ Motion</button>
                        <button class="trigger-btn" data-trigger="door:open" onclick="Builder.selectTrigger(this)">ğŸšª Door Open</button>
                        <button class="trigger-btn" data-trigger="sunset" onclick="Builder.selectTrigger(this)">ğŸŒ… Sunset</button>
                    </div>
                </div>
            </div>

            <!-- Step 3 -->
            <div class="builder-step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <label>Conditions (If)</label>
                    <div class="condition-options" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <label class="feature-box" style="padding: 10px 15px; cursor: pointer;">
                            <input type="checkbox" id="cond-home" checked style="margin-right: 8px;">
                            <span>ğŸ  Someone home</span>
                        </label>
                        <label class="feature-box" style="padding: 10px 15px; cursor: pointer;">
                            <input type="checkbox" id="cond-dark" style="margin-right: 8px;">
                            <span>ğŸŒ‘ It's dark</span>
                        </label>
                        <label class="feature-box" style="padding: 10px 15px; cursor: pointer;">
                            <input type="checkbox" id="cond-weekday" style="margin-right: 8px;">
                            <span>ğŸ“… Weekday</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Step 4 -->
            <div class="builder-step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <label>Actions (Then)</label>
                    <div class="action-options" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <label class="feature-box" style="padding: 10px 15px; cursor: pointer;">
                            <input type="checkbox" id="act-lights" checked style="margin-right: 8px;">
                            <span>ğŸ’¡ Lights On</span>
                        </label>
                        <label class="feature-box" style="padding: 10px 15px; cursor: pointer;">
                            <input type="checkbox" id="act-thermo" style="margin-right: 8px;">
                            <span>ğŸŒ¡ï¸ Set Temp</span>
                        </label>
                        <label class="feature-box" style="padding: 10px 15px; cursor: pointer;">
                            <input type="checkbox" id="act-lock" style="margin-right: 8px;">
                            <span>ğŸ”’ Lock Door</span>
                        </label>
                        <label class="feature-box" style="padding: 10px 15px; cursor: pointer;">
                            <input type="checkbox" id="act-notify" style="margin-right: 8px;">
                            <span>ğŸ“± Notify Me</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="builder-preview" style="padding: 20px; background: rgba(0, 210, 255, 0.05); border: 1px solid rgba(0, 210, 255, 0.2); border-radius: 15px; margin-bottom: 25px;">
            <h5 style="color: var(--primary); margin-bottom: 10px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px;">ğŸ“‹ Logic Preview</h5>
            <div class="preview-content" id="builder-preview" style="font-family: monospace; font-size: 1.1em;">
                <strong>Morning Routine</strong>: WHEN â° 7:00 AM, IF ğŸ  Someone home -> ğŸ’¡ Lights On
            </div>
        </div>

        <div class="builder-actions" style="display: flex; gap: 15px; margin-bottom: 25px;">
            <button class="btn-build" onclick="Builder.build()" style="flex: 2;">
                <span>ğŸ”¨ Build & Activate Rule</span>
            </button>
            <button class="btn-save" onclick="Builder.preset('random')" style="flex: 1; background: var(--glass-bg); border: 1px solid var(--glass-border);">
                <span>ğŸ² Random</span>
            </button>
        </div>

        <div class="preset-rules" style="padding-top: 20px; border-top: 1px solid var(--glass-border);">
            <h5 style="color: var(--text-muted); margin-bottom: 15px;">âš¡ Quick Presets</h5>
            <div class="preset-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="action-btn" onclick="Builder.preset('morning')" style="padding: 8px 15px; border-radius: 20px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text); cursor: pointer;">ğŸŒ… Morning</button>
                <button class="action-btn" onclick="Builder.preset('night')" style="padding: 8px 15px; border-radius: 20px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text); cursor: pointer;">ğŸŒ™ Goodnight</button>
                <button class="action-btn" onclick="Builder.preset('away')" style="padding: 8px 15px; border-radius: 20px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text); cursor: pointer;">ğŸ›¡ï¸ Away</button>
            </div>
        </div>

        <div class="pattern-explanation" style="margin-top: 25px;">
            <h5>ğŸ’¡ Pattern Logic</h5>
            <ul>
                <li><strong>Director:</strong> (User UI) Guides the sequence (Step 1 -> 2 -> 3 -> 4).</li>
                <li><strong>Builder:</strong> Accumulates configuration state (`AutomationRule.Builder`).</li>
                <li><strong>Product:</strong> The final complex `AutomationRule` object is only created when `build()` is called.</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="builder-result"></div>
</div>
<script>
var Builder = {
    selectedTrigger: 'time:07:00',
    selectTrigger: function(btn) {
        document.querySelectorAll('.trigger-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        this.selectedTrigger = btn.dataset.trigger;
        this.updatePreview();
    },
    updatePreview: function() {
        var name = document.getElementById('builder-name').value || 'My Rule';
        var trigger = this.selectedTrigger;
        var triggerText = {'time:07:00':'â° 7:00 AM','time:22:00':'ğŸŒ™ 10:00 PM','motion':'ğŸš¶ Motion','door:open':'ğŸšª Door Open','sunset':'ğŸŒ… Sunset','sunrise':'ğŸŒ„ Sunrise'}[trigger] || trigger;

        var conditions = [];
        if (document.getElementById('cond-home').checked) conditions.push('ğŸ  Someone home');
        if (document.getElementById('cond-dark').checked) conditions.push('ğŸŒ‘ It\'s dark');
        if (document.getElementById('cond-weekday').checked) conditions.push('ğŸ“… Weekday');

        var actions = [];
        if (document.getElementById('act-lights').checked) actions.push('ğŸ’¡ Lights On');
        if (document.getElementById('act-thermo').checked) actions.push('ğŸŒ¡ï¸ Set Temp');
        if (document.getElementById('act-lock').checked) actions.push('ğŸ”’ Lock Door');
        if (document.getElementById('act-notify').checked) actions.push('ğŸ“± Notify');

        var preview = '<strong>' + name + '</strong>: WHEN ' + triggerText;
        if (conditions.length > 0) preview += ', IF <span style="color: var(--warning)">' + conditions.join(' & ') + '</span>';
        if (actions.length > 0) preview += ' -> <span style="color: var(--success)">' + actions.join(', ') + '</span>';
        else preview += ' -> (No Action)';

        document.getElementById('builder-preview').innerHTML = preview;
    },
    build: function() {
        var name = document.getElementById('builder-name').value;
        var actions = [];
        if (document.getElementById('act-lights').checked) actions.push('LIGHTS_ON');
        if (document.getElementById('act-lock').checked) actions.push('LOCK_DOOR');

        PatternDemo.showResult('builder-result', 'ğŸ—ï¸ Builder constructing rule...\n' +
            '> Setting Name: ' + name + '\n' +
            '> Setting Trigger: ' + this.selectedTrigger + '\n' +
            '> Adding Conditions: ' + (document.getElementById('cond-home').checked ? 'HOME' : 'NONE') + '\n' +
            '> Adding Actions: ' + (actions.length > 0 ? actions.join(', ') : 'NONE') + '\n' +
            '> Validating...\n' +
            '> Result: AutomationRule built and active! ID: RULE-' + Math.floor(Math.random()*1000));

        PatternDemo.toast('Rule Built Successfully', 'success');

        // Simulate API call
        // fetch(...)
    },
    preset: function(type) {
        if (type === 'random') {
            type = ['morning', 'night', 'away'][Math.floor(Math.random() * 3)];
        }
        var presets = {
            morning: {name:'Morning Routine',trigger:'time:07:00',lights:true,thermo:true,home:true,dark:false,weekday:true},
            night: {name:'Goodnight',trigger:'time:22:00',lights:false,lock:true,home:true,dark:true,weekday:false},
            away: {name:'Away Mode',trigger:'door:open',lock:true,notify:true,home:false,dark:false,weekday:false},
            welcome: {name:'Welcome Home',trigger:'motion',lights:true,thermo:true,home:true,dark:true,weekday:false}
        };
        var p = presets[type];
        if(!p) return;

        document.getElementById('builder-name').value = p.name;

        document.querySelectorAll('.trigger-btn').forEach(function(b) {
            b.classList.remove('active');
            if(b.dataset.trigger===p.trigger) {
                b.classList.add('active');
                Builder.selectedTrigger = p.trigger;
            }
        });

        document.getElementById('cond-home').checked = p.home || false;
        document.getElementById('cond-dark').checked = p.dark || false;
        document.getElementById('cond-weekday').checked = p.weekday || false;

        document.getElementById('act-lights').checked = p.lights || false;
        document.getElementById('act-thermo').checked = p.thermo || false;
        document.getElementById('act-lock').checked = p.lock || false;
        document.getElementById('act-notify').checked = p.notify || false;

        this.updatePreview();
        PatternDemo.toast('Preset: ' + p.name, 'info');
    }
};
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('#pattern-builder input').forEach(function(el) {
        el.addEventListener('change', function() { Builder.updatePreview(); });
        el.addEventListener('input', function() { Builder.updatePreview(); });
    });
    // Init preview
    if(window.getComputedStyle(document.getElementById('pattern-builder')).display !== 'none') {
        Builder.updatePreview();
    }
});
</script>
</div>
