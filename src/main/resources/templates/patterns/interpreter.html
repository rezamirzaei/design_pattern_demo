<div class="pattern-card" id="pattern-interpreter" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">üìñ</div>
        <div class="pattern-info">
            <h3>Automation Rule Interpreter</h3>
            <span class="pattern-badge badge-behavioral">Interpreter Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">Define a grammar for <strong>automation rules</strong> and interpret expressions like "IF motion AND dark THEN lights_on". The interpreter evaluates these rules against current home state.</p>
    <div class="pattern-demo">
        <h4>üéÆ Create & Evaluate Rules</h4>
        <div class="rule-builder">
            <div class="rule-input">
                <label>Rule Expression:</label>
                <input type="text" id="interp-rule" class="form-input" value="motion_detected AND is_dark" placeholder="e.g., motion_detected AND is_dark">
            </div>
            <div class="quick-expressions">
                <button class="expr-btn" onclick="Interpreter.setExpr('motion_detected')">motion_detected</button>
                <button class="expr-btn" onclick="Interpreter.setExpr('is_dark')">is_dark</button>
                <button class="expr-btn" onclick="Interpreter.setExpr('door_open')">door_open</button>
                <button class="expr-btn" onclick="Interpreter.setExpr('temp_high')">temp_high</button>
                <button class="expr-btn op" onclick="Interpreter.appendExpr(' AND ')">AND</button>
                <button class="expr-btn op" onclick="Interpreter.appendExpr(' OR ')">OR</button>
                <button class="expr-btn op" onclick="Interpreter.appendExpr('NOT ')">NOT</button>
            </div>
        </div>
        <div class="context-state">
            <h5>üè† Current Home State (Context)</h5>
            <div class="state-toggles">
                <label class="state-toggle">
                    <input type="checkbox" id="ctx-motion" checked onchange="Interpreter.updateContext()">
                    <span class="toggle-box"><span class="toggle-icon">üö∂</span> motion_detected</span>
                </label>
                <label class="state-toggle">
                    <input type="checkbox" id="ctx-dark" checked onchange="Interpreter.updateContext()">
                    <span class="toggle-box"><span class="toggle-icon">üåô</span> is_dark</span>
                </label>
                <label class="state-toggle">
                    <input type="checkbox" id="ctx-door" onchange="Interpreter.updateContext()">
                    <span class="toggle-box"><span class="toggle-icon">üö™</span> door_open</span>
                </label>
                <label class="state-toggle">
                    <input type="checkbox" id="ctx-temp" onchange="Interpreter.updateContext()">
                    <span class="toggle-box"><span class="toggle-icon">üå°Ô∏è</span> temp_high</span>
                </label>
            </div>
        </div>
        <button class="btn-evaluate" onclick="Interpreter.evaluate()">üîç Evaluate Rule</button>
        <div class="eval-result" id="interp-eval-result">
            <div class="result-pending">Click "Evaluate Rule" to interpret the expression...</div>
        </div>
        <div class="pattern-explanation">
            <h5>üí° How Interpreter Works:</h5>
            <ul>
                <li><strong>Grammar</strong>: Expression ::= Terminal | AndExpr | OrExpr | NotExpr</li>
                <li><strong>Terminal Expression</strong>: Variables like motion_detected, is_dark</li>
                <li><strong>Non-terminal Expression</strong>: AND, OR, NOT operations</li>
                <li><strong>Context</strong>: Current state (which variables are true/false)</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="interpreter-result"></div>
</div>
<script>
var Interpreter = {
    setExpr: function(expr) {
        document.getElementById('interp-rule').value = expr;
    },
    appendExpr: function(expr) {
        var input = document.getElementById('interp-rule');
        input.value += expr;
        input.focus();
    },
    updateContext: function() {
        // Visual feedback when context changes
    },
    evaluate: function() {
        var rule = document.getElementById('interp-rule').value;
        var context = {
            motion_detected: document.getElementById('ctx-motion').checked,
            is_dark: document.getElementById('ctx-dark').checked,
            door_open: document.getElementById('ctx-door').checked,
            temp_high: document.getElementById('ctx-temp').checked
        };
        // Simple client-side evaluation for demo
        var result = this.evalExpression(rule, context);
        var resultEl = document.getElementById('interp-eval-result');
        resultEl.innerHTML = '<div class="result-' + (result ? 'true' : 'false') + '">' +
            '<span class="result-icon">' + (result ? '‚úÖ' : '‚ùå') + '</span>' +
            '<span class="result-text">Result: <strong>' + result.toString().toUpperCase() + '</strong></span>' +
            '</div>' +
            '<div class="result-details">' +
            '<div>Expression: ' + rule + '</div>' +
            '<div>Context: ' + Object.entries(context).map(function(e) { return e[0] + '=' + e[1]; }).join(', ') + '</div>' +
            '</div>';
        fetch('/api/patterns/interpreter/evaluate?rule=' + encodeURIComponent(rule) + '&' + Object.entries(context).map(function(e) { return e[0] + '=' + e[1]; }).join('&'), {method:'POST'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                PatternDemo.showResult('interpreter-result', 'Rule Interpreted!\n\nExpression: ' + rule + '\nResult: ' + result + '\n\nThe Interpreter pattern parsed and evaluated the expression tree.\n\n' + JSON.stringify(data, null, 2));
                PatternDemo.toast('Rule: ' + (result ? 'TRUE' : 'FALSE'), result ? 'success' : 'info');
            });
    },
    evalExpression: function(expr, ctx) {
        expr = expr.trim();
        // Handle NOT
        if (expr.startsWith('NOT ')) {
            return !this.evalExpression(expr.substring(4), ctx);
        }
        // Handle AND
        if (expr.indexOf(' AND ') > -1) {
            var parts = expr.split(' AND ');
            return parts.every(function(p) { return Interpreter.evalExpression(p, ctx); });
        }
        // Handle OR
        if (expr.indexOf(' OR ') > -1) {
            var parts = expr.split(' OR ');
            return parts.some(function(p) { return Interpreter.evalExpression(p, ctx); });
        }
        // Terminal - lookup in context
        return ctx[expr] === true;
    }
};
</script>
<style>
.rule-builder { margin-bottom: 20px; }
.rule-input { margin-bottom: 12px; }
.rule-input label { display: block; color: #00d2ff; margin-bottom: 6px; font-size: 0.9em; }
.rule-input .form-input { width: 100%; padding: 12px 15px; font-family: monospace; font-size: 1em; }
.quick-expressions { display: flex; flex-wrap: wrap; gap: 8px; }
.expr-btn { padding: 8px 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #ccc; cursor: pointer; font-family: monospace; }
.expr-btn:hover { background: rgba(0,210,255,0.1); border-color: rgba(0,210,255,0.3); }
.expr-btn.op { background: rgba(0,210,255,0.1); color: #00d2ff; }
.context-state { padding: 15px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 15px; }
.context-state h5 { color: #888; margin-bottom: 12px; font-size: 0.9em; }
.state-toggles { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.state-toggle { cursor: pointer; }
.state-toggle input { display: none; }
.toggle-box { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.1); border-radius: 10px; transition: all 0.3s; }
.state-toggle input:checked + .toggle-box { background: rgba(0,210,255,0.15); border-color: #00d2ff; }
.toggle-icon { font-size: 1.2em; }
.btn-evaluate { width: 100%; padding: 14px; background: linear-gradient(90deg, #00d2ff, #3a7bd5); border: none; border-radius: 10px; color: white; font-size: 1.1em; cursor: pointer; margin-bottom: 15px; }
.eval-result { padding: 20px; background: rgba(0,0,0,0.3); border-radius: 12px; }
.result-pending { color: #888; font-style: italic; }
.result-true, .result-false { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
.result-icon { font-size: 2em; }
.result-true { color: #7ee787; }
.result-false { color: #dc3545; }
.result-details { font-size: 0.85em; color: #888; font-family: monospace; }
.result-details div { margin-bottom: 5px; }
</style>
</div>
