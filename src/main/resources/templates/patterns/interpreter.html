<div class="pattern-card" id="pattern-interpreter" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">ğŸ“–</div>
        <div class="pattern-info">
            <h3>Rule Engine</h3>
            <span class="pattern-badge badge-behavioral">Interpreter Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Define a grammar for simple languages and an interpreter to deal with it.
        Evaluating "IF motion AND dark THEN light_on" involves parsing the expression into an Abstract Syntax Tree (AST) and executing it against the current context.
    </p>

    <div class="pattern-demo">
        <h4>ğŸ® Logic Studio</h4>

        <div class="rule-builder" style="background: var(--darker); padding: 30px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <div class="step-label" style="color: var(--primary); font-size: 0.9em; text-transform: uppercase; font-weight: 700; margin-bottom: 20px; letter-spacing: 1.5px; display: flex; align-items: center; gap: 8px;">
                <span style="background: rgba(0, 210, 255, 0.2); padding: 4px 8px; border-radius: 6px;">1</span> Compose Rule Expression
            </div>

            <div class="rule-input-wrapper" style="position: relative; margin-bottom: 25px;">
                <div style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); font-size: 1.4em; opacity: 0.8; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));">ğŸ“œ</div>
                <input type="text" id="interp-rule" class="form-input" value="motion_detected AND is_dark"
                       style="width: 100%; padding: 18px 18px 18px 60px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 12px; font-family: 'Consolas', monospace; color: var(--warning); font-size: 1.2em; letter-spacing: 0.5px; box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);">
            </div>

            <div class="quick-expressions" style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="action-btn" onclick="Interpreter.setExpr('motion_detected')" style="padding: 10px 18px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 20px; color: var(--text-muted); cursor: pointer; transition: all 0.2s; font-weight: 500;">ğŸš¶ motion</button>
                <button class="action-btn" onclick="Interpreter.setExpr('is_dark')" style="padding: 10px 18px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 20px; color: var(--text-muted); cursor: pointer; transition: all 0.2s; font-weight: 500;">ğŸŒ™ dark</button>
                <button class="action-btn" onclick="Interpreter.setExpr('door_open')" style="padding: 10px 18px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 20px; color: var(--text-muted); cursor: pointer; transition: all 0.2s; font-weight: 500;">ğŸšª door</button>

                <div style="width: 1px; background: var(--glass-border); margin: 0 10px;"></div>

                <button class="action-btn" onclick="Interpreter.appendExpr(' AND ')" style="padding: 10px 18px; background: rgba(0, 210, 255, 0.1); border: 1px solid var(--primary); border-radius: 20px; color: var(--primary); font-weight: 800; cursor: pointer;">AND</button>
                <button class="action-btn" onclick="Interpreter.appendExpr(' OR ')" style="padding: 10px 18px; background: rgba(0, 210, 255, 0.1); border: 1px solid var(--primary); border-radius: 20px; color: var(--primary); font-weight: 800; cursor: pointer;">OR</button>
                <button class="action-btn" onclick="Interpreter.appendExpr(' NOT ')" style="padding: 10px 18px; background: rgba(220, 53, 69, 0.1); border: 1px solid var(--danger); border-radius: 20px; color: var(--danger); font-weight: 800; cursor: pointer;">NOT</button>
            </div>
        </div>

        <div class="context-state" style="background: var(--darker); padding: 30px; border-radius: 16px; border: 1px solid var(--glass-border); margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <div class="step-label" style="color: var(--secondary); font-size: 0.9em; text-transform: uppercase; font-weight: 700; margin-bottom: 20px; letter-spacing: 1.5px; display: flex; align-items: center; gap: 8px;">
                <span style="background: rgba(255, 193, 7, 0.2); padding: 4px 8px; border-radius: 6px; color: var(--warning);">2</span> Set Context Environment
            </div>
            <div class="state-toggles" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px;">
                <label class="feature-box" style="cursor: pointer; padding: 15px; background: var(--glass-bg); border-radius: 10px; border: 1px solid var(--glass-border); transition: all 0.3s; display: flex; align-items: center;">
                    <input type="checkbox" id="ctx-motion" checked onchange="Interpreter.updateUI()" style="margin-right: 10px; accent-color: var(--primary); transform: scale(1.2);">
                    <span style="font-weight: 600;">ğŸš¶ Motion Detected</span>
                </label>
                <label class="feature-box" style="cursor: pointer; padding: 15px; background: var(--glass-bg); border-radius: 10px; border: 1px solid var(--glass-border); transition: all 0.3s; display: flex; align-items: center;">
                    <input type="checkbox" id="ctx-dark" checked onchange="Interpreter.updateUI()" style="margin-right: 10px; accent-color: var(--primary); transform: scale(1.2);">
                    <span style="font-weight: 600;">ğŸŒ™ Is Dark</span>
                </label>
                <label class="feature-box" style="cursor: pointer; padding: 15px; background: var(--glass-bg); border-radius: 10px; border: 1px solid var(--glass-border); transition: all 0.3s; display: flex; align-items: center;">
                    <input type="checkbox" id="ctx-door" onchange="Interpreter.updateUI()" style="margin-right: 10px; accent-color: var(--primary); transform: scale(1.2);">
                    <span style="font-weight: 600;">ğŸšª Door Open</span>
                </label>
                <label class="feature-box" style="cursor: pointer; padding: 15px; background: var(--glass-bg); border-radius: 10px; border: 1px solid var(--glass-border); transition: all 0.3s; display: flex; align-items: center;">
                    <input type="checkbox" id="ctx-temp" onchange="Interpreter.updateUI()" style="margin-right: 10px; accent-color: var(--primary); transform: scale(1.2);">
                    <span style="font-weight: 600;">ğŸŒ¡ï¸ Temp High</span>
                </label>
            </div>
        </div>

        <button class="btn-primary" onclick="Interpreter.evaluate()" style="width: 100%; margin-bottom: 25px; padding: 18px; border-radius: 12px; font-weight: 700; font-size: 1.1em; background: linear-gradient(135deg, var(--primary), var(--secondary)); border: none; cursor: pointer; box-shadow: 0 0 20px rgba(0, 210, 255, 0.3); transition: transform 0.2s;">
            <span>ğŸ” INTERPRET & EVALUATE</span>
        </button>

        <div class="eval-result" id="interp-eval-result" style="display: none; padding: 20px; background: var(--glass-bg); border-radius: 12px; border-left: 4px solid var(--success); animation: slideUp 0.3s ease-out;">
            <!-- Result injected here -->
        </div>

        <div class="pattern-explanation" style="margin-top: 25px;">
            <h5>ğŸ’¡ Pattern Logic</h5>
            <ul>
                <li><strong>Context:</strong> A Map containing variable values (e.g., `motion=true`).</li>
                <li><strong>Terminal Expression:</strong> Returns the value of a variable from Context.</li>
                <li><strong>Non-Terminal Expression:</strong> Combines results (AND, OR, NOT).</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="interpreter-result"></div>
<script>
var Interpreter = {
    setExpr: function(expr) {
        document.getElementById('interp-rule').value = expr;
    },
    appendExpr: function(expr) {
        var input = document.getElementById('interp-rule');
        input.value += expr;
        input.focus();
    },
    updateUI: function() {
        // Highlight active states
        document.querySelectorAll('#pattern-interpreter input[type="checkbox"]').forEach(cb => {
            var box = cb.parentElement;
            if(cb.checked) {
                box.style.borderColor = 'var(--primary)';
                box.style.background = 'rgba(0, 210, 255, 0.15)';
            } else {
                box.style.borderColor = 'var(--glass-border)';
                box.style.background = 'var(--glass-bg)';
            }
        });
    },
    evaluate: function() {
        var rule = document.getElementById('interp-rule').value;
        var context = {
            motion_detected: document.getElementById('ctx-motion').checked,
            is_dark: document.getElementById('ctx-dark').checked,
            door_open: document.getElementById('ctx-door').checked,
            temp_high: document.getElementById('ctx-temp').checked
        };

        // Simulate interpretation (simple client-side logic)
        // Note: Real Interpreter pattern would parse this into an object tree server-side
        var result = false;
        try {
            // Very basic parser for demo (Not real Interpreter pattern implementation, just simulation)
            var jsExpr = rule.replace(/AND/g, '&&').replace(/OR/g, '||').replace(/NOT/g, '!');
            // Replace vars with values
            for (var key in context) {
                jsExpr = jsExpr.replace(new RegExp(key, 'g'), context[key]);
            }
            result = eval(jsExpr);
        } catch (e) {
            result = false;
        }

        var resultEl = document.getElementById('interp-eval-result');
        resultEl.style.display = 'block';
        resultEl.style.borderColor = result ? 'var(--success)' : 'var(--danger)';

        resultEl.innerHTML = '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">' +
            '<span style="font-size: 1.5em; font-weight: 700; color: ' + (result ? 'var(--success)' : 'var(--danger)') + ';">' + (result ? 'TRUE âœ…' : 'FALSE âŒ') + '</span>' +
            '<span style="color: var(--text-muted); font-size: 0.9em;">Evaluation Result</span>' +
            '</div>' +
            '<div style="font-family: monospace; color: var(--text-muted); font-size: 0.9em;">' +
            '> AST Root Node -> Evaluate(Context)<br>' +
            '> Parsing: ' + rule + '<br>' +
            '> Context Hit: ' + Object.keys(context).filter(k => !!context[k]).length + ' active variables' +
            '</div>';

        fetch('/api/patterns/interpreter/evaluate?rule=' + encodeURIComponent(rule) + '&' + Object.entries(context).map(e => e[0] + '=' + e[1]).join('&'), {method:'POST'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var serverResult = (data && typeof data.result === 'boolean') ? data.result : result;
                PatternDemo.showResult('interpreter-result', 'ğŸ§© Interpreter Parsed Expression:\n' +
                    '------------------------------\n' +
                    'Expression: "' + rule + '"\n' +
                    'Variables: ' + JSON.stringify((data && data.variables) ? data.variables : context) + '\n' +
                    'Result: ' + serverResult.toString().toUpperCase());
                PatternDemo.toast('Expression Evaluated', 'success');
            });
    }
};
// Init UI
Interpreter.updateUI();
</script>
</div>
