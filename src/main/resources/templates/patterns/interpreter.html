<div class="pattern-card" id="pattern-interpreter" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">ğŸ“–</div>
        <div class="pattern-info">
            <h3>Rule Engine</h3>
            <span class="pattern-badge badge-behavioral">Interpreter Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Define a grammar for simple languages and an interpreter to deal with it.
        Evaluating "IF motion AND dark THEN light_on" involves parsing the expression into an Abstract Syntax Tree (AST) and executing it against the current context.
    </p>

    <div class="pattern-demo">
        <h4>ğŸ® Logic Studio</h4>

        <div class="rule-builder" style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 25px;">
            <div class="rule-input" style="padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid var(--glass-border);">
                <label style="display: block; color: var(--text-muted); margin-bottom: 10px; font-size: 0.9em; text-transform: uppercase;">1. Compose Rule Expression</label>
                <div style="position: relative;">
                    <div style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 1.2em; opacity: 0.5;">ğŸ“œ</div>
                    <input type="text" id="interp-rule" class="form-input" value="motion_detected AND is_dark" style="padding-left: 45px; font-family: 'Consolas', monospace; color: var(--warning); background: var(--darker); border-color: var(--glass-border);">
                </div>
            </div>

            <div class="quick-expressions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="action-btn" onclick="Interpreter.setExpr('motion_detected')" style="padding: 8px 14px; background: var(--glass-bg); border-radius: 20px; font-size: 0.85em; font-family: monospace;">ğŸš¶ motion</button>
                <button class="action-btn" onclick="Interpreter.setExpr('is_dark')" style="padding: 8px 14px; background: var(--glass-bg); border-radius: 20px; font-size: 0.85em; font-family: monospace;">ğŸŒ™ dark</button>
                <button class="action-btn" onclick="Interpreter.setExpr('door_open')" style="padding: 8px 14px; background: var(--glass-bg); border-radius: 20px; font-size: 0.85em; font-family: monospace;">ğŸšª door</button>

                <div style="width: 1px; background: var(--glass-border); margin: 0 10px;"></div>

                <button class="action-btn" onclick="Interpreter.appendExpr(' AND ')" style="color: var(--primary);">AND</button>
                <button class="action-btn" onclick="Interpreter.appendExpr(' OR ')" style="color: var(--primary);">OR</button>
                <button class="action-btn" onclick="Interpreter.appendExpr(' NOT ')" style="color: var(--danger);">NOT</button>
            </div>
        </div>

        <div class="context-state" style="padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--glass-border);">
            <h5 style="color: var(--primary); margin-bottom: 15px; font-size: 0.9em; text-transform: uppercase;">2. Set Context (Environment)</h5>
            <div class="state-toggles" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                <label class="feature-box" style="cursor: pointer; padding: 12px; background: var(--glass-bg); border-radius: 8px; border: 1px solid var(--glass-border); transition: all 0.3s;">
                    <input type="checkbox" id="ctx-motion" checked onchange="Interpreter.updateUI()" style="margin-right: 8px;">
                    <span>ğŸš¶ Motion Detected</span>
                </label>
                <label class="feature-box" style="cursor: pointer; padding: 12px; background: var(--glass-bg); border-radius: 8px; border: 1px solid var(--glass-border); transition: all 0.3s;">
                    <input type="checkbox" id="ctx-dark" checked onchange="Interpreter.updateUI()" style="margin-right: 8px;">
                    <span>ğŸŒ™ Is Dark</span>
                </label>
                <label class="feature-box" style="cursor: pointer; padding: 12px; background: var(--glass-bg); border-radius: 8px; border: 1px solid var(--glass-border); transition: all 0.3s;">
                    <input type="checkbox" id="ctx-door" onchange="Interpreter.updateUI()" style="margin-right: 8px;">
                    <span>ğŸšª Door Open</span>
                </label>
                <label class="feature-box" style="cursor: pointer; padding: 12px; background: var(--glass-bg); border-radius: 8px; border: 1px solid var(--glass-border); transition: all 0.3s;">
                    <input type="checkbox" id="ctx-temp" onchange="Interpreter.updateUI()" style="margin-right: 8px;">
                    <span>ğŸŒ¡ï¸ Temp High</span>
                </label>
            </div>
        </div>

        <button class="btn-primary" onclick="Interpreter.evaluate()" style="width: 100%; margin-bottom: 20px;">
            <span>ğŸ” Interpret & Evaluate</span>
        </button>

        <div class="eval-result" id="interp-eval-result" style="display: none; padding: 20px; background: var(--glass-bg); border-radius: 12px; border-left: 4px solid var(--success); animation: slideUp 0.3s ease-out;">
            <!-- Result injected here -->
        </div>

        <div class="pattern-explanation" style="margin-top: 25px;">
            <h5>ğŸ’¡ Pattern Logic</h5>
            <ul>
                <li><strong>Context:</strong> A Map containing variable values (e.g., `motion=true`).</li>
                <li><strong>Terminal Expression:</strong> Returns the value of a variable from Context.</li>
                <li><strong>Non-Terminal Expression:</strong> Combines results (AND, OR, NOT).</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="interpreter-result"></div>
</div>
<script>
var Interpreter = {
    setExpr: function(expr) {
        document.getElementById('interp-rule').value = expr;
    },
    appendExpr: function(expr) {
        var input = document.getElementById('interp-rule');
        input.value += expr;
        input.focus();
    },
    updateUI: function() {
        // Highlight active states
        document.querySelectorAll('#pattern-interpreter input[type="checkbox"]').forEach(cb => {
            var box = cb.parentElement;
            if(cb.checked) {
                box.style.borderColor = 'var(--primary)';
                box.style.background = 'rgba(0, 210, 255, 0.15)';
            } else {
                box.style.borderColor = 'var(--glass-border)';
                box.style.background = 'var(--glass-bg)';
            }
        });
    },
    evaluate: function() {
        var rule = document.getElementById('interp-rule').value;
        var context = {
            motion_detected: document.getElementById('ctx-motion').checked,
            is_dark: document.getElementById('ctx-dark').checked,
            door_open: document.getElementById('ctx-door').checked,
            temp_high: document.getElementById('ctx-temp').checked
        };

        // Simulate interpretation (simple client-side logic)
        // Note: Real Interpreter pattern would parse this into an object tree server-side
        var result = false;
        try {
            // Very basic parser for demo (Not real Interpreter pattern implementation, just simulation)
            var jsExpr = rule.replace(/AND/g, '&&').replace(/OR/g, '||').replace(/NOT/g, '!');
            // Replace vars with values
            for (var key in context) {
                jsExpr = jsExpr.replace(new RegExp(key, 'g'), context[key]);
            }
            result = eval(jsExpr);
        } catch (e) {
            result = false;
        }

        var resultEl = document.getElementById('interp-eval-result');
        resultEl.style.display = 'block';
        resultEl.style.borderColor = result ? 'var(--success)' : 'var(--danger)';

        resultEl.innerHTML = '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">' +
            '<span style="font-size: 1.5em; font-weight: 700; color: ' + (result ? 'var(--success)' : 'var(--danger)') + ';">' + (result ? 'TRUE âœ…' : 'FALSE âŒ') + '</span>' +
            '<span style="color: var(--text-muted); font-size: 0.9em;">Evaluation Result</span>' +
            '</div>' +
            '<div style="font-family: monospace; color: var(--text-muted); font-size: 0.9em;">' +
            '> AST Root Node -> Evaluate(Context)<br>' +
            '> Parsing: ' + rule + '<br>' +
            '> Context Hit: ' + Object.keys(context).filter(k => context[key]).length + ' active variables' +
            '</div>';

        fetch('/api/patterns/interpreter/evaluate?rule=' + encodeURIComponent(rule) + '&' + Object.entries(context).map(e => e[0] + '=' + e[1]).join('&'), {method:'POST'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                PatternDemo.showResult('interpreter-result', 'ğŸ§© Interpreter Parsed Expression:\n' +
                    '------------------------------\n' +
                    'Expression: "' + rule + '"\n' +
                    'Variables: ' + JSON.stringify(context) + '\n' +
                    'Result: ' + result.toString().toUpperCase());
                PatternDemo.toast('Expression Evaluated', 'success');
            });
    }
};
// Init UI
Interpreter.updateUI();
</script>
</div>
