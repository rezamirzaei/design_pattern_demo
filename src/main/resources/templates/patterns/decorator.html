<div class="pattern-card" id="pattern-decorator" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">üé®</div>
        <div class="pattern-info">
            <h3>Feature Decorator</h3>
            <span class="pattern-badge badge-structural">Decorator Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Dynamically add responsibilities to an object at runtime. The <strong>Decorator Pattern</strong> wraps the original object (Device) with layers of enhanced functionality (Logging, Security, Caching) without altering the device class itself.
    </p>

    <div class="pattern-demo">
        <h4>üéÆ Enhance Your Device</h4>

        <div class="decorator-workspace" style="display: flex; gap: 20px; flex-wrap: wrap;">
            <!-- Device Selection -->
            <div class="device-selection pd-panel">
                <h5 style="color: var(--primary); margin-bottom: 15px; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px;">1Ô∏è‚É£ Select Base Device</h5>
                <div class="device-list" style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                    <button class="device-item active" data-device="living-light-1" onclick="Decorator.selectDevice(this, 'living-light-1')" style="padding: 15px; display: flex; align-items: center; gap: 15px; background: rgba(0, 210, 255, 0.15); border: 1px solid var(--primary); border-radius: 10px; cursor: pointer; color: white;">
                        <span class="device-icon" style="font-size: 1.5em; background: rgba(0,0,0,0.2); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">üí°</span>
                        <span class="device-name" style="font-weight: 600;">Living Room Light</span>
                    </button>
                    <button class="device-item" data-device="bed-thermo" onclick="Decorator.selectDevice(this, 'bed-thermo')" style="padding: 15px; display: flex; align-items: center; gap: 15px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; cursor: pointer; color: var(--text-muted);">
                        <span class="device-icon" style="font-size: 1.5em; background: rgba(0,0,0,0.2); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">üå°Ô∏è</span>
                        <span class="device-name" style="font-weight: 600;">Bedroom Thermostat</span>
                    </button>
                    <button class="device-item" data-device="front-camera" onclick="Decorator.selectDevice(this, 'front-camera')" style="padding: 15px; display: flex; align-items: center; gap: 15px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; cursor: pointer; color: var(--text-muted);">
                        <span class="device-icon" style="font-size: 1.5em; background: rgba(0,0,0,0.2); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">üì∑</span>
                        <span class="device-name" style="font-weight: 600;">Front Camera</span>
                    </button>
                    <button class="device-item" data-device="main-lock" onclick="Decorator.selectDevice(this, 'main-lock')" style="padding: 15px; display: flex; align-items: center; gap: 15px; background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 10px; cursor: pointer; color: var(--text-muted);">
                        <span class="device-icon" style="font-size: 1.5em; background: rgba(0,0,0,0.2); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">üîí</span>
                        <span class="device-name" style="font-weight: 600;">Main Door Lock</span>
                    </button>
                </div>
            </div>

            <!-- Feature Selection -->
            <div class="feature-selection pd-panel">
                <h5 style="color: var(--secondary); margin-bottom: 15px; text-transform: uppercase; font-size: 0.9em; letter-spacing: 1px;">2Ô∏è‚É£ Stack Features</h5>
                <div class="feature-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <label class="feature-checkbox" style="cursor: pointer; display: block;">
                        <input type="checkbox" id="feat-logging" value="LOGGING" checked onchange="Decorator.updatePreview()" style="display: none;">
                        <span class="feature-box" style="padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--glass-bg); display: flex; align-items: center; gap: 12px; transition: all 0.2s;">
                            <span class="checkbox-indicator" style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--text-muted); display: inline-block;"></span>
                            <span class="feature-icon" style="font-size: 1.2em;">üìù</span>
                            <span class="feature-info" style="display: flex; flex-direction: column;">
                                <span class="feature-name" style="font-weight: 600;">Logging</span>
                                <span class="feature-desc" style="font-size: 0.8em; color: var(--text-muted);">Audit trail for operations</span>
                            </span>
                        </span>
                    </label>
                    <label class="feature-checkbox" style="cursor: pointer; display: block;">
                        <input type="checkbox" id="feat-security" value="SECURITY" onchange="Decorator.updatePreview()" style="display: none;">
                        <span class="feature-box" style="padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--glass-bg); display: flex; align-items: center; gap: 12px; transition: all 0.2s;">
                            <span class="checkbox-indicator" style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--text-muted); display: inline-block;"></span>
                            <span class="feature-icon" style="font-size: 1.2em;">üîê</span>
                            <span class="feature-info" style="display: flex; flex-direction: column;">
                                <span class="feature-name" style="font-weight: 600;">Security</span>
                                <span class="feature-desc" style="font-size: 0.8em; color: var(--text-muted);">Auth & Access Control</span>
                            </span>
                        </span>
                    </label>
                    <label class="feature-checkbox" style="cursor: pointer; display: block;">
                        <input type="checkbox" id="feat-caching" value="CACHING" onchange="Decorator.updatePreview()" style="display: none;">
                        <span class="feature-box" style="padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--glass-bg); display: flex; align-items: center; gap: 12px; transition: all 0.2s;">
                            <span class="checkbox-indicator" style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--text-muted); display: inline-block;"></span>
                            <span class="feature-icon" style="font-size: 1.2em;">‚ö°</span>
                            <span class="feature-info" style="display: flex; flex-direction: column;">
                                <span class="feature-name" style="font-weight: 600;">Caching</span>
                                <span class="feature-desc" style="font-size: 0.8em; color: var(--text-muted);">Boost read performance</span>
                            </span>
                        </span>
                    </label>
                    <label class="feature-checkbox" style="cursor: pointer; display: block;">
                        <input type="checkbox" id="feat-notification" value="NOTIFICATION" onchange="Decorator.updatePreview()" style="display: none;">
                        <span class="feature-box" style="padding: 12px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--glass-bg); display: flex; align-items: center; gap: 12px; transition: all 0.2s;">
                            <span class="checkbox-indicator" style="width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--text-muted); display: inline-block;"></span>
                            <span class="feature-icon" style="font-size: 1.2em;">üîî</span>
                            <span class="feature-info" style="display: flex; flex-direction: column;">
                                <span class="feature-name" style="font-weight: 600;">Alerts</span>
                                <span class="feature-desc" style="font-size: 0.8em; color: var(--text-muted);">Push notifications</span>
                            </span>
                        </span>
                    </label>
                </div>
            </div>

            <!-- Decorator Preview -->
            <div class="decorator-preview">
                <h5>3Ô∏è‚É£ Wrapper Chain</h5>
                <div class="chain-visual" id="decorator-chain" style="min-height: 80px;">
                    <div class="chain-item base">üì± Device</div>
                    <div class="chain-arrow">‚Üí</div>
                    <div class="chain-item decorator">üìù Logging</div>
                </div>
                <p class="chain-desc" id="chain-description" style="text-align: center; color: var(--text-muted); font-size: 0.9em;">
                    Wrapper stack: Logging( Device )
                </p>
            </div>

            <button class="btn-primary" onclick="Decorator.apply()" style="width: 100%; margin-top: 10px;">
                <span class="btn-icon">üéÅ</span> Apply Wrappers
            </button>
        </div>

        <div class="pattern-explanation">
            <h5>üí° Pattern Logic</h5>
            <ul>
                <li><strong>Component:</strong> `SmartDevice` interface.</li>
                <li><strong>Concrete Component:</strong> `SimpleLight` implements `SmartDevice`.</li>
                <li><strong>Decorator:</strong> `FeatureDecorator` implements `SmartDevice` AND contains a `SmartDevice`.</li>
                <li><strong>Recursive wrapping:</strong> `new SecurityDecorator(new LoggingDecorator(new SimpleLight()))`.</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="decorator-result"></div>
<script>
var Decorator = {
    selectedDevice: 'living-light-1',
    selectDevice: function(btn, device) {
        document.querySelectorAll('.device-item').forEach(function(b) {
            b.classList.remove('active');
            b.style.background = 'var(--glass-bg)';
            b.style.borderColor = 'var(--glass-border)';
            b.style.color = 'var(--text-muted)';
        });
        btn.classList.add('active');
        btn.style.background = 'rgba(0, 210, 255, 0.15)';
        btn.style.borderColor = 'var(--primary)';
        btn.style.color = 'white';
        this.selectedDevice = device;
        this.updatePreview();
    },
    getSelectedFeatures: function() {
        return Array.from(document.querySelectorAll('.feature-checkbox input:checked')).map(el => el.value);
    },
    updatePreview: function() {
        // Update visual state of checkboxes
        document.querySelectorAll('.feature-checkbox input').forEach(input => {
            var box = input.nextElementSibling;
            if(input.checked) {
                box.style.background = 'rgba(0, 210, 255, 0.15)';
                box.style.borderColor = 'var(--primary)';
                box.querySelector('.checkbox-indicator').style.background = 'var(--primary)';
                box.querySelector('.checkbox-indicator').style.borderColor = 'var(--primary)';
            } else {
                box.style.background = 'var(--glass-bg)';
                box.style.borderColor = 'var(--glass-border)';
                box.querySelector('.checkbox-indicator').style.background = 'transparent';
                box.querySelector('.checkbox-indicator').style.borderColor = 'var(--text-muted)';
            }
        });

        var features = this.getSelectedFeatures();
        var chain = document.getElementById('decorator-chain');
        var icons = { LOGGING: 'üìù', SECURITY: 'üîê', CACHING: '‚ö°', NOTIFICATION: 'üîî' };
        var names = { LOGGING: 'Logging', SECURITY: 'Security', CACHING: 'Caching', NOTIFICATION: 'Alerts' };

        var html = '<div class="chain-item base" style="background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px;">üì± Device</div>';

        features.forEach(function(f) {
            html = '<div class="chain-item decorator" style="background: rgba(0,210,255,0.15); border: 1px solid var(--primary); padding: 8px 12px; border-radius: 8px; color: var(--primary);">' + icons[f] + ' ' + names[f] + '</div>' +
                   '<div class="chain-arrow" style="margin: 0 5px; color: var(--text-muted);">‚ûú</div>' +
                   html;
        });

        chain.innerHTML = html;
        var desc = features.length === 0
            ? 'Base Object: No wrappers applied.'
            : 'Wrappers: ' + features.map(function(f) { return names[f]; }).join('( ') + '( Device )' + ')'.repeat(features.length);
        document.getElementById('chain-description').textContent = desc;
    },
    apply: function() {
        var features = this.getSelectedFeatures();
        if (features.length === 0) {
            PatternDemo.toast('Select at least one feature!', 'error');
            return;
        }

        // Simulate loading
        PatternDemo.showResult('decorator-result', 'üéÅ Wrapping device layers...\n' +
            '> Base: ' + this.selectedDevice + '\n' +
            features.map((f, i) => '> Layer ' + (i+1) + ': "new ' + f.charAt(0) + f.slice(1).toLowerCase() + 'Decorator(...)"').join('\n') +
            '\n> Object construction complete.\n> Ready to execute enhanced commands.');

        PatternDemo.toast('Decorators Applied!', 'success');

        // Actual API call
        var url = '/api/patterns/decorator/wrap?deviceId=' + this.selectedDevice + '&decorators=' + features.join(',');
        fetch(url, { method: 'POST' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var output = 'üé® Decorators Applied (Server)\n' +
                    '----------------------------\n' +
                    'Device: ' + (data.deviceInfo || Decorator.selectedDevice) + '\n' +
                    'Stack: ' + (Array.isArray(data.decorators) ? data.decorators.join(' -> ') : features.join(' -> ')) + '\n\n' +
                    'Status #1: ' + (data.status1 || '-') + '\n' +
                    'Status #2: ' + (data.status2 || '-') + '\n' +
                    'Security Auth: ' + (data.securityAuthenticated ? 'YES' : 'NO') + '\n' +
                    (data.cacheStats ? ('Cache: ' + JSON.stringify(data.cacheStats)) : '');
                PatternDemo.showResult('decorator-result', output);
            })
            .catch(function(err) {
                PatternDemo.toast('Decorator API failed', 'error');
                PatternDemo.showResult('decorator-result', '‚ùå Failed to apply decorators\n' + err);
            });
    }
};
// Initialize preview
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Decorator !== 'undefined') Decorator.updatePreview();
});
</script>
</div>
