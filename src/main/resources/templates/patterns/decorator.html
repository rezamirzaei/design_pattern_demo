<div class="pattern-card" id="pattern-decorator" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">üé®</div>
        <div class="pattern-info">
            <h3>Feature Decorator</h3>
            <span class="pattern-badge badge-structural">Decorator Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Dynamically add responsibilities to an object at runtime. The <strong>Decorator Pattern</strong> wraps the original object (Device) with layers of enhanced functionality (Logging, Security, Caching) without altering the device class itself.
    </p>

    <div class="pattern-demo">
        <h4>üéÆ Enhance Your Device</h4>

        <div class="decorator-workspace">
            <!-- Device Selection -->
            <div class="device-selection">
                <h5>1Ô∏è‚É£ Select Base Device</h5>
                <div class="device-list">
                    <button class="device-item active" data-device="living-light-1" onclick="Decorator.selectDevice(this, 'living-light-1')">
                        <span class="device-icon">üí°</span>
                        <span class="device-name">Living Room Light</span>
                    </button>
                    <button class="device-item" data-device="bedroom-thermostat" onclick="Decorator.selectDevice(this, 'bedroom-thermostat')">
                        <span class="device-icon">üå°Ô∏è</span>
                        <span class="device-name">Bedroom Thermostat</span>
                    </button>
                    <button class="device-item" data-device="front-camera" onclick="Decorator.selectDevice(this, 'front-camera')">
                        <span class="device-icon">üì∑</span>
                        <span class="device-name">Front Camera</span>
                    </button>
                    <button class="device-item" data-device="main-lock" onclick="Decorator.selectDevice(this, 'main-lock')">
                        <span class="device-icon">üîí</span>
                        <span class="device-name">Main Door Lock</span>
                    </button>
                </div>
            </div>

            <!-- Feature Selection -->
            <div class="feature-selection">
                <h5>2Ô∏è‚É£ Stack Features</h5>
                <div class="feature-list">
                    <label class="feature-checkbox">
                        <input type="checkbox" id="feat-logging" value="LOGGING" checked onchange="Decorator.updatePreview()">
                        <span class="feature-box">
                            <span class="feature-icon">üìù</span>
                            <span class="feature-info">
                                <span class="feature-name">Logging</span>
                                <span class="feature-desc">Audit trail for operations</span>
                            </span>
                        </span>
                    </label>
                    <label class="feature-checkbox">
                        <input type="checkbox" id="feat-security" value="SECURITY" onchange="Decorator.updatePreview()">
                        <span class="feature-box">
                            <span class="feature-icon">üîê</span>
                            <span class="feature-info">
                                <span class="feature-name">Security</span>
                                <span class="feature-desc">Auth & Access Control</span>
                            </span>
                        </span>
                    </label>
                    <label class="feature-checkbox">
                        <input type="checkbox" id="feat-caching" value="CACHING" onchange="Decorator.updatePreview()">
                        <span class="feature-box">
                            <span class="feature-icon">‚ö°</span>
                            <span class="feature-info">
                                <span class="feature-name">Caching</span>
                                <span class="feature-desc">Boost read performance</span>
                            </span>
                        </span>
                    </label>
                    <label class="feature-checkbox">
                        <input type="checkbox" id="feat-notification" value="NOTIFICATION" onchange="Decorator.updatePreview()">
                        <span class="feature-box">
                            <span class="feature-icon">üîî</span>
                            <span class="feature-info">
                                <span class="feature-name">Alerts</span>
                                <span class="feature-desc">Push notifications</span>
                            </span>
                        </span>
                    </label>
                </div>
            </div>

            <!-- Decorator Preview -->
            <div class="decorator-preview">
                <h5>3Ô∏è‚É£ Wrapper Chain</h5>
                <div class="chain-visual" id="decorator-chain" style="min-height: 80px;">
                    <div class="chain-item base">üì± Device</div>
                    <div class="chain-arrow">‚Üí</div>
                    <div class="chain-item decorator">üìù Logging</div>
                </div>
                <p class="chain-desc" id="chain-description" style="text-align: center; color: var(--text-muted); font-size: 0.9em;">
                    Wrapper stack: Logging( Device )
                </p>
            </div>

            <button class="btn-primary" onclick="Decorator.apply()" style="width: 100%; margin-top: 10px;">
                <span class="btn-icon">üéÅ</span> Apply Wrappers
            </button>
        </div>

        <div class="pattern-explanation" style="margin-top: 25px;">
            <h5>üí° Pattern Logic</h5>
            <ul>
                <li><strong>Component:</strong> `SmartDevice` interface.</li>
                <li><strong>Concrete Component:</strong> `SimpleLight` implements `SmartDevice`.</li>
                <li><strong>Decorator:</strong> `FeatureDecorator` implements `SmartDevice` AND contains a `SmartDevice`.</li>
                <li><strong>Recursive wrapping:</strong> `new SecurityDecorator(new LoggingDecorator(new SimpleLight()))`.</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="decorator-result"></div>
</div>
<script>
var Decorator = {
    selectedDevice: 'living-light-1',
    selectDevice: function(btn, deviceId) {
        document.querySelectorAll('#pattern-decorator .device-item').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        this.selectedDevice = deviceId;
        this.updatePreview();
    },
    getSelectedFeatures: function() {
        var features = [];
        if (document.getElementById('feat-logging').checked) features.push('LOGGING');
        if (document.getElementById('feat-security').checked) features.push('SECURITY');
        if (document.getElementById('feat-caching').checked) features.push('CACHING');
        if (document.getElementById('feat-notification').checked) features.push('NOTIFICATION');
        return features;
    },
    updatePreview: function() {
        var features = this.getSelectedFeatures();
        var chain = document.getElementById('decorator-chain');
        var icons = { LOGGING: 'üìù', SECURITY: 'üîê', CACHING: '‚ö°', NOTIFICATION: 'üîî' };
        var names = { LOGGING: 'Logging', SECURITY: 'Security', CACHING: 'Caching', NOTIFICATION: 'Alerts' };

        var html = '<div class="chain-item base" style="background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px;">üì± Device</div>';

        features.forEach(function(f) {
            html = '<div class="chain-item decorator" style="background: rgba(0,210,255,0.15); border: 1px solid var(--primary); padding: 8px 12px; border-radius: 8px; color: var(--primary);">' + icons[f] + ' ' + names[f] + '</div>' +
                   '<div class="chain-arrow" style="margin: 0 5px; color: var(--text-muted);">‚ûú</div>' +
                   html;
        });

        chain.innerHTML = html;
        var desc = features.length === 0
            ? 'Base Object: No wrappers applied.'
            : 'Wrappers: ' + features.map(function(f) { return names[f]; }).join('( ') + '( Device )' + ')'.repeat(features.length);
        document.getElementById('chain-description').textContent = desc;
    },
    apply: function() {
        var features = this.getSelectedFeatures();
        if (features.length === 0) {
            PatternDemo.toast('Select at least one feature!', 'error');
            return;
        }

        // Simulate loading
        PatternDemo.showResult('decorator-result', 'üéÅ Wrapping device layers...\n' +
            '> Base: ' + this.selectedDevice + '\n' +
            features.map((f, i) => '> Layer ' + (i+1) + ': "new ' + f.charAt(0) + f.slice(1).toLowerCase() + 'Decorator(...)"').join('\n') +
            '\n> Object construction complete.\n> Ready to execute enhanced commands.');

        PatternDemo.toast('Decorators Applied!', 'success');

        // Actual API call
        var url = '/api/patterns/decorator/wrap?deviceId=' + this.selectedDevice + '&decorators=' + features.join(',');
        fetch(url, { method: 'POST' });
    }
};
// Initialize preview
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Decorator !== 'undefined') Decorator.updatePreview();
});
</script>
