<div class="pattern-card" id="pattern-template" th:fragment="content">
    <div class="pattern-header">
        <div class="pattern-icon">üìã</div>
        <div class="pattern-info">
            <h3>Boot Sequence</h3>
            <span class="pattern-badge badge-behavioral">Template Method Pattern</span>
        </div>
    </div>
    <p class="pattern-desc">
        Define the skeleton of an algorithm in the superclass but let subclasses override specific steps.
        This ensures the <strong>structure remains invariant</strong> while steps can be specialized.
    </p>

    <div class="pattern-demo">
        <h4>üéÆ Device Initializer</h4>

        <div class="device-init-selector" style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 30px;">
            <button class="init-btn" onclick="Template.init('LIGHT')" style="display: flex; flex-direction: column; align-items: center; padding: 25px; background: var(--darker); border: 1px solid var(--glass-border); border-radius: 16px; color: var(--text); cursor: pointer; transition: all 0.2s; width: 130px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                <span style="font-size: 3.5em; margin-bottom: 10px; background: rgba(255,255,255,0.05); width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">üí°</span>
                <span style="font-weight: 700; font-size: 1.1em;">Lights</span>
            </button>
            <button class="init-btn" onclick="Template.init('THERMOSTAT')" style="display: flex; flex-direction: column; align-items: center; padding: 25px; background: var(--darker); border: 1px solid var(--glass-border); border-radius: 16px; color: var(--text); cursor: pointer; transition: all 0.2s; width: 130px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                <span style="font-size: 3.5em; margin-bottom: 10px; background: rgba(255,255,255,0.05); width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">üå°Ô∏è</span>
                <span style="font-weight: 700; font-size: 1.1em;">Thermo</span>
            </button>
            <button class="init-btn" onclick="Template.init('CAMERA')" style="display: flex; flex-direction: column; align-items: center; padding: 25px; background: var(--darker); border: 1px solid var(--glass-border); border-radius: 16px; color: var(--text); cursor: pointer; transition: all 0.2s; width: 130px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                <span style="font-size: 3.5em; margin-bottom: 10px; background: rgba(255,255,255,0.05); width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">üì∑</span>
                <span style="font-weight: 700; font-size: 1.1em;">Camera</span>
            </button>
            <button class="init-btn" onclick="Template.init('LOCK')" style="display: flex; flex-direction: column; align-items: center; padding: 25px; background: var(--darker); border: 1px solid var(--glass-border); border-radius: 16px; color: var(--text); cursor: pointer; transition: all 0.2s; width: 130px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                <span style="font-size: 3.5em; margin-bottom: 10px; background: rgba(255,255,255,0.05); width: 70px; height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">üîí</span>
                <span style="font-weight: 700; font-size: 1.1em;">Lock</span>
            </button>
        </div>

        <div class="init-progress" style="padding: 30px; background: var(--darker); border-radius: 20px; border: 1px solid var(--glass-border); position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: linear-gradient(180deg, var(--primary), var(--secondary));"></div>
            <div style="position: absolute; top: 20px; right: 25px; font-family: 'Consolas', monospace; color: var(--text-muted); font-size: 0.85em; opacity: 0.5;">boot_sequence.sh</div>
            <h5 style="color: var(--primary); margin-bottom: 25px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px;">üìä Initialization Pipeline</h5>

            <div class="progress-steps" id="init-steps" style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Step 1: Base -->
                <div class="step" id="step-1" style="display: flex; align-items: center; gap: 20px; padding: 18px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 12px; transition: all 0.3s;">
                    <div class="step-num" style="width: 36px; height: 36px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-family: monospace;">1</div>
                    <div class="step-info" style="flex: 1;">
                        <div class="step-name" style="font-weight: 600; color: var(--text-muted);">Common: Connect Network</div>
                    </div>
                    <div class="step-status"></div>
                </div>

                <!-- Step 2: Base -->
                <div class="step" id="step-2" style="display: flex; align-items: center; gap: 20px; padding: 18px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 12px; transition: all 0.3s;">
                    <div class="step-num" style="width: 36px; height: 36px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-family: monospace;">2</div>
                    <div class="step-info" style="flex: 1;">
                        <div class="step-name" style="font-weight: 600; color: var(--text-muted);">Common: Authenticate</div>
                    </div>
                    <div class="step-status"></div>
                </div>

                <!-- Step 3: Abstract -->
                <div class="step" id="step-3" style="display: flex; align-items: center; gap: 20px; padding: 18px; background: rgba(255,255,255,0.03); border: 1px dashed var(--primary); border-radius: 12px; transition: all 0.3s;">
                    <div class="step-num" style="width: 36px; height: 36px; background: rgba(0, 210, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-family: monospace; color: var(--primary);">3</div>
                    <div class="step-info" style="flex: 1;">
                        <div class="step-name" style="font-weight: 700; color: var(--text);">HOOK: Device Specific Setup</div>
                        <div class="step-desc" id="step-3-desc" style="font-size: 0.85em; color: var(--primary); font-style: italic; margin-top: 4px;">(Overridden by subclass)</div>
                    </div>
                    <div class="step-status"></div>
                </div>

                <!-- Step 4: Base -->
                <div class="step" id="step-4" style="display: flex; align-items: center; gap: 20px; padding: 18px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 12px; transition: all 0.3s;">
                    <div class="step-num" style="width: 36px; height: 36px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-family: monospace;">4</div>
                    <div class="step-info" style="flex: 1;">
                        <div class="step-name" style="font-weight: 600; color: var(--text-muted);">Common: Hub Register</div>
                    </div>
                    <div class="step-status"></div>
                </div>

                <!-- Step 5: Final -->
                <div class="step" id="step-5" style="display: flex; align-items: center; gap: 20px; padding: 18px; background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 12px; transition: all 0.3s;">
                    <div class="step-num" style="width: 36px; height: 36px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-family: monospace;">5</div>
                    <div class="step-info" style="flex: 1;">
                        <div class="step-name" style="font-weight: 600; color: var(--text-muted);">DONE: Ready</div>
                    </div>
                    <div class="step-status"></div>
                </div>
            </div>
        </div>

        <div class="pattern-explanation" style="margin-top: 25px;">
            <h5>üí° Pattern Logic</h5>
            <ul>
                <li><strong>Abstract Class:</strong> Defines `final void initialize()` skeleton calling steps 1-5.</li>
                <li><strong>Common Methods:</strong> Steps 1, 2, 4 are standard.</li>
                <li><strong>Abstract Method:</strong> Step 3 `setupHardware()` is abstract, forcing subclasses to implement valid logic.</li>
            </ul>
        </div>
    </div>
    <div class="result-area" id="template-result"></div>
<script>
var Template = {
    init: function(deviceType) {
        var specificSteps = {
            LIGHT: { desc: '‚ö° Voltage Check -> üé® Color Calibration', icon: 'üí°' },
            THERMOSTAT: { desc: 'üå°Ô∏è Sensor Calibration -> üìÖ Schedule Sync', icon: 'üå°Ô∏è' },
            CAMERA: { desc: 'üì∑ Lens Focus -> üíæ Storage Check', icon: 'üì∑' },
            LOCK: { desc: 'üîë Key Exchange -> ‚öôÔ∏è Motor Test', icon: 'üîí' }
        };

        // Reset steps
        document.querySelectorAll('.step').forEach(function(s) {
            s.style.background = 'rgba(255,255,255,0.02)';
            s.style.borderColor = 'var(--glass-border)';
            s.querySelector('.step-name').style.color = 'var(--text-muted)';
            s.querySelector('.step-status').innerHTML = '';
            s.querySelector('.step-num').style.background = 'rgba(255,255,255,0.1)';
        });

        // Setup Step 3
        var step3 = document.getElementById('step-3');
        step3.style.borderColor = 'var(--accent)';
        document.getElementById('step-3-desc').innerHTML = specificSteps[deviceType].desc;
        step3.querySelector('.step-name').style.color = 'var(--accent)';

        // Animation Loop
        var steps = ['step-1', 'step-2', 'step-3', 'step-4', 'step-5'];
        var delay = 0;

        steps.forEach(function(stepId, index) {
            setTimeout(function() {
                var step = document.getElementById(stepId);

                // Active State
                step.style.background = 'rgba(0, 210, 255, 0.1)';
                step.style.borderColor = 'var(--primary)';
                step.querySelector('.step-name').style.color = 'var(--text)';
                step.querySelector('.step-status').innerHTML = '<span style="animation: spin 1s infinite">‚è≥</span>';

                // Done State (after short processing)
                setTimeout(function() {
                    step.style.background = 'rgba(40, 167, 69, 0.1)';
                    step.style.borderColor = 'var(--success)';
                    step.querySelector('.step-num').style.background = 'var(--success)';
                    step.querySelector('.step-status').innerHTML = '‚úÖ';
                }, 400);
            }, delay);
            delay += 500;
        });

        // API Call
        fetch('/api/patterns/template/init?deviceType=' + deviceType, {method:'POST'})
            .then(function(r) { return r.json(); })
            .then(function(data) {
                setTimeout(function() {
                    PatternDemo.showResult('template-result', '‚úÖ ' + deviceType + ' Online\n' +
                        '-------------------------\n' +
                        'Template Method Execution Complete.\n' +
                        'Invariant Steps: 1, 2, 4, 5\n' +
                        'Variant Step: 3 (' + specificSteps[deviceType].desc + ')');
                    PatternDemo.toast('Device Ready', 'success');
                }, 2500);
            });
    }
};
</script>
<style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
</div>
