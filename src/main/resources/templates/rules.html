<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('Smart Home â€” Rules')}"></head>
<body>
    <nav th:replace="~{fragments/layout :: navbar('rules')}"></nav>
    <div th:replace="~{fragments/layout :: toasts}"></div>

    <main class="container" role="main">
        <header>
            <h1>ðŸ§  Automation Rules</h1>
            <p class="subtitle">Create smart automation logic â€” "If X then Y" rules for your home</p>
        </header>

        <div class="section">
            <h2 class="section-title">âž• Create Rule <span class="title-badge">Interpreter + Builder Patterns</span></h2>
            <div class="card">
                <form data-api-endpoint="/rules/create" data-api-method="POST" data-refresh="true">
                    <div class="form-row">
                        <div>
                            <label for="ruleName">Name</label>
                            <input id="ruleName" name="name" placeholder="e.g. Motion Lights" required>
                        </div>
                        <div>
                            <label for="rulePriority">Priority (0â€“10)</label>
                            <input id="rulePriority" name="priority" type="number" min="0" max="10" placeholder="5" value="5">
                        </div>
                    </div>

                    <label for="ruleDesc">Description</label>
                    <input id="ruleDesc" name="description" placeholder="e.g. Turn on lights when motion is detected after 6pm">

                    <label for="triggerCondition">IF (Trigger Condition)</label>
                    <input id="triggerCondition" name="triggerCondition" placeholder="e.g. motion AND hour >= 18" required>

                    <label for="actionScript">THEN (Action Script)</label>
                    <textarea id="actionScript" name="actionScript" rows="3"
                              placeholder="e.g. turn_on(living-light-1); room_off(Living Room)" required></textarea>

                    <details style="margin-top:10px">
                        <summary style="cursor:pointer; color:var(--text-muted); font-size:0.9em">Available Actions Reference</summary>
                        <div class="help-grid" style="margin-top:10px">
                            <code>turn_on(deviceId)</code>
                            <code>turn_off(deviceId)</code>
                            <code>toggle(deviceId)</code>
                            <code>room_on(roomName)</code>
                            <code>room_off(roomName)</code>
                            <code>mode(NORMAL|AWAY|NIGHT)</code>
                            <code>scene(sceneName)</code>
                        </div>
                    </details>

                    <button class="btn btn-primary" type="submit" style="margin-top:12px">
                        <span class="btn-icon">ðŸ§ </span> Create Rule
                    </button>
                </form>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">ðŸ“‹ Rules</h2>

            <div th:if="${#lists.isEmpty(rules)}" class="empty-state">
                <div class="empty-icon">ðŸ§ </div>
                <h3>No automation rules yet</h3>
                <p>Create your first rule above to automate your home.</p>
            </div>

            <div class="grid" th:unless="${#lists.isEmpty(rules)}">
                <div class="card" th:each="rule : ${rules}"
                     th:classappend="${!rule.isEnabled} ? ' card-disabled' : ''">
                    <div class="card-header">
                        <span class="card-title" th:text="${rule.name}">Rule</span>
                        <span class="badge"
                              th:classappend="${rule.isEnabled} ? 'badge-success' : 'badge-muted'"
                              th:text="${rule.isEnabled ? ('âœ“ Enabled Â· P' + rule.priority) : ('âœ— Disabled Â· P' + rule.priority)}">Enabled</span>
                    </div>

                    <p class="muted" th:text="${rule.description != null ? rule.description : 'No description'}">â€”</p>

                    <div class="rule-logic">
                        <div class="rule-condition">
                            <span class="rule-label">IF</span>
                            <code th:text="${rule.triggerCondition}">condition</code>
                        </div>
                        <div class="rule-action">
                            <span class="rule-label">THEN</span>
                            <code th:text="${rule.actionScript}">action</code>
                        </div>
                    </div>

                    <details style="margin-top:12px">
                        <summary style="cursor:pointer; color:var(--primary); font-weight:600">â–¶ Test Run</summary>
                        <form data-api-method="POST" th:attr="data-api-endpoint='/rules/' + ${rule.id} + '/run'" style="margin-top:10px">
                            <label th:attr="for=${'vars-' + rule.id}">Variables (key=value per line)</label>
                            <textarea th:attr="id=${'vars-' + rule.id}" name="vars" rows="3"
                                      placeholder="motion=true&#10;hour=20"></textarea>
                            <label style="display:flex; gap: 10px; align-items: center; margin-top: 8px; cursor:pointer">
                                <input type="checkbox" name="executeActions" value="true" style="width:auto; margin-bottom:0">
                                <span class="muted">Execute actions if rule matches</span>
                            </label>
                            <button class="btn btn-primary btn-sm" type="submit" style="margin-top: 10px;">â–¶ Run</button>
                        </form>
                    </details>

                    <div class="rule-actions">
                        <form class="inline-form" data-api-method="POST" data-refresh="true" th:attr="data-api-endpoint='/rules/' + ${rule.id} + '/toggle'">
                            <button class="btn btn-sm" type="submit"
                                    th:classappend="${rule.isEnabled} ? 'btn-secondary' : 'btn-primary'"
                                    th:text="${rule.isEnabled ? 'â¸ Disable' : 'â–¶ Enable'}">Toggle</button>
                        </form>
                        <form class="inline-form" data-api-method="POST" data-refresh="true"
                              th:attr="data-api-endpoint='/rules/' + ${rule.id} + '/delete'"
                              onsubmit="return confirm('Delete this rule?')">
                            <button class="btn btn-danger btn-sm" type="submit">ðŸ—‘ Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div th:replace="~{fragments/layout :: outputLog}"></div>
    </main>

    <div th:replace="~{fragments/layout :: scripts}"></div>
    <footer th:replace="~{fragments/layout :: footer}"></footer>
</body>
</html>
